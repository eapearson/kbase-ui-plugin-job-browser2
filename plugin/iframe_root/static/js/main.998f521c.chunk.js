(this["webpackJsonpreact-app"]=this["webpackJsonpreact-app"]||[]).push([[0],{419:function(e,t,n){e.exports=n(847)},424:function(e,t,n){},804:function(e,t,n){},823:function(e,t,n){},826:function(e,t,n){},840:function(e,t,n){},841:function(e,t,n){},843:function(e,t,n){},844:function(e,t,n){},845:function(e,t,n){},846:function(e,t,n){},847:function(e,t,n){"use strict";n.r(t);var r,a=n(0),i=n.n(a),s=n(9),o=n.n(s),u=(n(424),n(17)),c=n(18),l=n(23),h=n(21),d=n(22),m=n(24),p=n(25);!function(e){e.MAIN_LOAD="main load",e.MAIN_LOAD_START="main load start",e.MAIN_LOAD_SUCCESS="main load success",e.MAIN_LOAD_ERROR="main load error",e.MAIN_UNLOAD="main/unload",e.MY_JOBS_SEARCH="my jobs search",e.MY_JOBS_SEARCH_START="my jobs search start",e.MY_JOBS_SEARCH_SUCCESS="my jobs search success",e.MY_JOBS_SEARCH_ERROR="my jobs search error",e.My_JOBS_REFRESH_SEARCH="my jobs refresh search",e.MY_JOBS_CANCEL="my jobs cancel",e.MY_JOBS_CANCEL_START="my jobs cancel start",e.MY_JOBS_CANCEL_SUCCESS="my jobs cancel success",e.MY_JOBS_CANCEL_ERROR="my jobs cancel error",e.USER_JOBS_SEARCH="user jobs search",e.USER_JOBS_SEARCH_START="user jobs search start",e.USER_JOBS_SEARCH_SUCCESS="user jobs search success",e.USER_JOBS_SEARCH_ERROR="user jobs search error",e.USER_JOBS_CANCEL="user jobs cancel",e.USER_JOBS_CANCEL_START="user jobs cancel start",e.USER_JOBS_CANCEL_SUCCESS="user jobs cancel success",e.USER_JOBS_CANCEL_ERROR="user jobs cancel error",e.PUBLIC_APP_STATS_SEARCH="publicAppStats/Search",e.PUBLIC_APP_STATS_SEARCH_START="publicAppStats/Search/Start",e.PUBLIC_APP_STATS_SEARCH_ERROR="publicAppStats/Search/Error",e.PUBLIC_APP_STATS_SEARCH_SUCCESS="publicAppStats/Search/Success",e.USER_RUN_SUMMARY_SEARCH="userRunSummary/Search",e.USER_RUN_SUMMARY_SEARCH_START="userRunSummary/Search/Start",e.USER_RUN_SUMMARY_SEARCH_ERROR="userRunSummary/Search/Error",e.USER_RUN_SUMMARY_SEARCH_SUCCESS="userRunSummary/Search/Success"}(r||(r={}));var E=function(e,t){if(!e)return e;switch(t.type){case r.MY_JOBS_SEARCH_SUCCESS:return function(e,t){return Object(m.a)({},e,{views:Object(m.a)({},e.views,{myJobsView:Object(m.a)({},e.views.myJobsView,{searchState:S.SEARCHED,rawJobs:t.rawJobs,jobs:t.jobs,jobsFetchedAt:t.jobsFetchedAt,searchExpression:t.searchExpression})})})}(e,t);case r.MY_JOBS_SEARCH_START:return function(e,t){return Object(m.a)({},e,{views:Object(m.a)({},e.views,{myJobsView:Object(m.a)({},e.views.myJobsView,{searchState:S.SEARCHING})})})}(e);case r.MY_JOBS_CANCEL_SUCCESS:return function(e,t){return Object(m.a)({},e,{views:Object(m.a)({},e.views,{myJobsView:Object(m.a)({},e.views.myJobsView)})})}(e);case r.MY_JOBS_SEARCH_ERROR:return function(e,t){return Object(m.a)({},e,{views:Object(m.a)({},e.views,{myJobsView:Object(m.a)({},e.views.myJobsView,{searchState:S.ERROR,error:t.error})})})}(e,t)}};var b=function(e,t){if(!e)return e;switch(t.type){case r.USER_JOBS_SEARCH_START:return function(e,t){return Object(m.a)({},e,{views:Object(m.a)({},e.views,{userJobsView:Object(m.a)({},e.views.userJobsView,{searchState:S.SEARCHING})})})}(e);case r.USER_JOBS_SEARCH_SUCCESS:return function(e,t){return Object(m.a)({},e,{views:Object(m.a)({},e.views,{userJobsView:Object(m.a)({},e.views.userJobsView,{searchState:S.SEARCHED,rawJobs:t.rawJobs,jobs:t.jobs,jobsFetchedAt:t.jobsFetchedAt,searchExpression:t.searchExpression})})})}(e,t);case r.USER_JOBS_CANCEL_START:case r.USER_JOBS_CANCEL_SUCCESS:return function(e,t){return Object(m.a)({},e,{views:Object(m.a)({},e.views,{userJobsView:Object(m.a)({},e.views.userJobsView)})})}(e)}};var f=function(e,t){if(!e)return e;switch(t.type){case r.MAIN_LOAD_SUCCESS:return function(e,t){return Object(m.a)({},e,{views:Object(m.a)({},e.views,{mainView:Object(m.a)({},e.views.mainView,{loadingState:R.SUCCESS,isAdmin:t.isAdmin})})})}(e,t);case r.MAIN_UNLOAD:return function(e,t){return Object(m.a)({},e,{views:Object(m.a)({},e.views,{mainView:{loadingState:R.NONE,isAdmin:!1,error:null}})})}(e)}};var v=function(e,t){if(!e)return e;switch(t.type){case r.PUBLIC_APP_STATS_SEARCH_START:return function(e,t){return Object(m.a)({},e,{views:Object(m.a)({},e.views,{publicAppStatsView:Object(m.a)({},e.views.publicAppStatsView,{searchState:S.SEARCHING})})})}(e);case r.PUBLIC_APP_STATS_SEARCH_SUCCESS:return function(e,t){return Object(m.a)({},e,{views:Object(m.a)({},e.views,{publicAppStatsView:Object(m.a)({},e.views.publicAppStatsView,{searchState:S.SEARCHED,appStats:t.appStats})})})}(e,t)}};var y,S,R,g=function(e,t){if(!e)return e;switch(t.type){case r.USER_RUN_SUMMARY_SEARCH_START:return function(e,t){return Object(m.a)({},e,{views:Object(m.a)({},e.views,{userRunSummaryView:Object(m.a)({},e.views.userRunSummaryView,{searchState:S.SEARCHING})})})}(e);case r.USER_RUN_SUMMARY_SEARCH_SUCCESS:return function(e,t){return Object(m.a)({},e,{views:Object(m.a)({},e.views,{userRunSummaryView:Object(m.a)({},e.views.userRunSummaryView,{searchState:S.SEARCHED,userRunSummary:t.userRunSummary})})})}(e,t)}},w=function(e,t){var n=Object(p.baseReducer)(e,t);return n||(f(e,t)||E(e,t)||b(e,t)||v(e,t)||g(e,t)||e)},N=n(159),C=n(414);!function(e){e.QUEUED="QUEUED",e.RUNNING="RUNNING",e.FINISHED="FINISHED",e.ERRORED_QUEUED="ERRORED_QUEUED",e.ERRORED_RUNNING="ERRORED_RUNNING",e.CANCELED_QUEUED="CANCELED_QUEUED",e.CANCELED_RUNNING="CANCELED_RUNNING"}(y||(y={})),function(e){e[e.NONE=0]="NONE",e[e.SEARCHING=1]="SEARCHING",e[e.SEARCHED=2]="SEARCHED",e[e.ERROR=3]="ERROR"}(S||(S={})),function(e){e[e.NONE=0]="NONE",e[e.LOADING=1]="LOADING",e[e.SUCCESS=2]="SUCCESS",e[e.ERROR=3]="ERROR"}(R||(R={}));var k=n(53),O=(n(174),n(70)),_=(n(139),n(55)),A=(n(380),n(5)),T=(n(804),n(176),n(28)),I=(n(122),n(31)),j=(n(382),n(145)),D=(n(273),n(65)),U=(n(275),n(109)),x=(n(175),n(64)),L=(n(201),n(40)),J=(n(389),n(111)),P=(n(274),n(42)),F=(n(390),n(143)),M=(n(83),n(27)),Q=n(20),G=n.n(Q),H=(n(383),n(146));function q(e){switch(e){case y.QUEUED:return"orange";case y.RUNNING:return"blue";case y.CANCELED_QUEUED:case y.CANCELED_RUNNING:return"gray";case y.FINISHED:return"green";case y.ERRORED_QUEUED:case y.ERRORED_RUNNING:return"red";default:throw new Error("Invalid job status")}}var z,B=function(e){function t(){return Object(u.a)(this,t),Object(l.a)(this,Object(h.a)(t).apply(this,arguments))}return Object(d.a)(t,e),Object(c.a)(t,[{key:"renderTag",value:function(){var e=function(e){switch(e){case y.QUEUED:return i.a.createElement("span",null,i.a.createElement(A.a,{type:"loading",spin:!0})," Queued");case y.RUNNING:return i.a.createElement("span",null,i.a.createElement(A.a,{type:"loading-3-quarters",spin:!0})," Running");case y.CANCELED_QUEUED:case y.CANCELED_RUNNING:return"Canceled";case y.FINISHED:return"Success";case y.ERRORED_QUEUED:case y.ERRORED_RUNNING:return"Errored";default:throw new Error("Invalid job status")}}(this.props.job.status),t=q(this.props.job.status);return i.a.createElement(H.a,{color:t},e)}},{key:"renderTiming",value:function(){switch(this.props.job.status){case y.QUEUED:return i.a.createElement("span",null,i.a.createElement(p.NiceElapsedTime,{from:this.props.job.queuedAt,useClock:!0}));case y.RUNNING:return i.a.createElement("span",null,i.a.createElement(p.NiceElapsedTime,{from:this.props.job.runAt,useClock:!0}));case y.FINISHED:case y.ERRORED_QUEUED:case y.ERRORED_RUNNING:case y.CANCELED_QUEUED:case y.CANCELED_RUNNING:return i.a.createElement("span",null,i.a.createElement(p.NiceRelativeTime,{time:new Date(this.props.job.finishAt)}))}}},{key:"render",value:function(){var e=this.props.showTiming?this.renderTiming():"";return i.a.createElement("span",null,this.renderTag(),e)}}]),t}(i.a.Component),V=n(79),W=n(14),Y=n.n(W),K=(n(823),function(e){function t(e){var n;return Object(u.a)(this,t),(n=Object(l.a)(this,Object(h.a)(t).call(this,e))).state={selectedTabIndex:0},n}return Object(d.a)(t,e),Object(c.a)(t,[{key:"selectTab",value:function(e){this.setState({selectedTabIndex:e})}},{key:"renderTabs",value:function(){var e=this;return this.props.tabs.map((function(t,n){var r=["FlexTabs-tab"];return n===e.state.selectedTabIndex&&r.push("FlexTabs-tab-active"),i.a.createElement("span",{key:String(n),className:r.join(" ")},i.a.createElement(M.a,{type:"link",onClick:function(){e.selectTab(n)}},t.title))}))}},{key:"renderTabBody",value:function(){return this.props.tabs[this.state.selectedTabIndex].component}},{key:"render",value:function(){return i.a.createElement("div",{className:"FlexTabs"},i.a.createElement("div",{className:"FlexTabs-header"},this.renderTabs()),i.a.createElement("div",{className:"FlexTabs-body"},this.renderTabBody()))}}]),t}(i.a.Component)),X=(n(381),n(110)),$=(n(824),n(72)),Z=(n(272),n(94)),ee=(n(826),n(284)),te=n.n(ee),ne=n(415),re=n.n(ne);!function(e){e[e.NONE=0]="NONE",e[e.PLAYING=1]="PLAYING",e[e.PAUSED=2]="PAUSED",e[e.DISABLED=3]="DISABLED"}(z||(z={}));var ae=function(e){function t(e){var n;return Object(u.a)(this,t),(n=Object(l.a)(this,Object(h.a)(t).call(this,e))).playLogTimer=void 0,n.bodyRef=void 0,n.currentJobStatus=void 0,n.playLogTimer=0,n.bodyRef=i.a.createRef(),n.currentJobStatus=null,n.state={playState:z.NONE,isPaused:!1},n}return Object(d.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.currentJobStatus=this.props.job.status,this.state.isPaused||this.isActive()&&this.scrollToBottom()}},{key:"scrollToBottom",value:function(){null!==this.bodyRef.current&&(this.bodyRef.current.scrollTop=this.bodyRef.current.scrollHeight)}},{key:"componentDidUpdate",value:function(){var e=this.currentJobStatus;this.currentJobStatus=this.props.job.status,this.state.isPaused||(this.isActive()||e!==y.RUNNING||this.props.job.status!==y.RUNNING)&&this.scrollToBottom()}},{key:"isActive",value:function(){return this.props.job.status===y.QUEUED||this.props.job.status===y.RUNNING}},{key:"renderLastLine",value:function(){var e;return e=this.isActive()?i.a.createElement("span",null,"Polling for additional log entries..."," ",i.a.createElement(_.a,{size:"small"})):i.a.createElement("div",{style:{textAlign:"center",fontStyle:"italic"}},"Log complete"),i.a.createElement("div",{className:"FlexTable-row",key:"END",style:{backgroundColor:"rgba(200, 200, 200, 0.5)"},"data-end":"end"},i.a.createElement("div",{className:"FlexTable-col"}),i.a.createElement("div",{className:"FlexTable-col"},e))}},{key:"renderJobLog",value:function(){var e=this.props.log;if(0===e.length)return i.a.createElement(Z.a,null);var t=e.map((function(e){var t={};return e.isError&&(t.color="red"),i.a.createElement("div",{className:"FlexTable-row",style:t,key:e.lineNumber},i.a.createElement("div",{className:"FlexTable-col"},e.lineNumber),i.a.createElement("div",{className:"FlexTable-col"},e.line))}));return t.push(this.renderLastLine()),i.a.createElement("div",{className:"FlexTable",key:"log"},i.a.createElement("div",{className:"FlexTable-header"},i.a.createElement("div",{className:"FlexTable-row"},i.a.createElement("div",{className:"FlexTable-col"},"Line #"),i.a.createElement("div",{className:"FlexTable-col"},"Log line"))),i.a.createElement("div",{className:"FlexTable-body",ref:this.bodyRef},t))}},{key:"renderJobLogRow",value:function(){}},{key:"renderJobLogLines",value:function(){return i.a.createElement(T.a,{dataSource:this.props.log,size:"small",rowKey:function(e){return String(e.lineNumber)},pagination:!1,scroll:{y:"100%"},rowClassName:function(e){return e.isError?"JobLog-errorRow":"JobLog-normalRow"}},i.a.createElement(T.a.Column,{title:"Row",dataIndex:"lineNumber",key:"lineNumber",width:"8%",render:function(e,t){var n=new Intl.NumberFormat("en-US",{useGrouping:!0}).format(e);return t.isError?i.a.createElement("span",{className:"JobLog-errorText"},n):n},sorter:function(e,t){return e.lineNumber-t.lineNumber}}),i.a.createElement(T.a.Column,{title:"Log line",dataIndex:"line",key:"line",width:"92%",render:function(e,t){var n;return n=t.isError?i.a.createElement("span",{className:"JobLog-errorText"},e):i.a.createElement("span",null,e),i.a.createElement(I.a,{title:e},n)}}))}},{key:"downloadLog",value:function(e,t){var n,r;switch(e){case"tsv":n="application/octet-stream",r=function(e){return te.a.unparse(e,{delimiter:"\t"})}(t);break;case"json":n="application/octet-stream",r=function(e){return JSON.stringify(e)}(t);break;case"text":n="text/plain",r=function(e){return e.map((function(e){return e.line})).join("\n")}(t);break;default:case"csv":n="application/octet-stream",r=function(e){return te.a.unparse(e)}(t)}!function(e,t,n){var r=document.createElement("a"),a=new Blob([n]);r.href=URL.createObjectURL(a),r.download=e,r.style.visibility="none",r.type=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(r.href)}("job-log."+e,n,r)}},{key:"onMenuClick",value:function(e){e&&this.downloadLog(e.key,this.props.log)}},{key:"onPlayLog",value:function(){this.scrollToBottom(),this.setState({playState:z.PLAYING,isPaused:!1})}},{key:"onPauseLog",value:function(){this.setState({playState:z.PAUSED,isPaused:!0})}},{key:"renderPlayPauseTooltips",value:function(){var e,t,n=this.state.isPaused;switch(this.props.job.status){case y.RUNNING:n?(e="Click to automatically scroll to the bottom of the logs when new entries arrive",t="Automatic scrolling is already paused"):(e="Automatic scrolling is already active",t="Click to pause automatic scrolling to the bottom of the logs when new entries arrive");break;case y.QUEUED:case y.FINISHED:case y.ERRORED_QUEUED:case y.ERRORED_RUNNING:case y.CANCELED_QUEUED:case y.CANCELED_RUNNING:default:e="Log playing only available when the job is running",t="Log playing only available when the job is running"}return[e,t]}},{key:"renderPlayPause",value:function(){var e;switch(this.props.job.status){case y.QUEUED:e=!0;break;case y.RUNNING:e=!1;break;case y.FINISHED:case y.ERRORED_QUEUED:case y.ERRORED_RUNNING:case y.CANCELED_QUEUED:case y.CANCELED_RUNNING:default:e=!0}var t=this.renderPlayPauseTooltips(),n=Object(V.a)(t,2),r=n[0],a=n[1];return i.a.createElement(re.a,null,i.a.createElement(I.a,{title:r},i.a.createElement(M.a,{icon:"caret-right",disabled:e||!this.state.isPaused,onClick:this.onPlayLog.bind(this)})),i.a.createElement(I.a,{title:a},i.a.createElement(M.a,{icon:"pause",disabled:e||this.state.isPaused,onClick:this.onPauseLog.bind(this)})))}},{key:"renderToolbar",value:function(){var e=0===this.props.log.length,t=i.a.createElement($.a,{onClick:this.onMenuClick.bind(this)},i.a.createElement($.a.Item,{key:"csv",disabled:e},"CSV"),i.a.createElement($.a.Item,{key:"tsv",disabled:e},"TSV"),i.a.createElement($.a.Item,{key:"json",disabled:e},"JSON"),i.a.createElement($.a.Item,{key:"text",disabled:e},"TEXT"));return i.a.createElement("div",{key:"toolbar"},i.a.createElement(X.a,{overlay:t},i.a.createElement(M.a,{icon:"download"}))," ",this.renderPlayPause())}},{key:"render",value:function(){return i.a.createElement("div",{className:"JobLog"},this.renderToolbar(),this.renderJobLog())}}]),t}(i.a.Component),ie=function(e){function t(){return Object(u.a)(this,t),Object(l.a)(this,Object(h.a)(t).apply(this,arguments))}return Object(d.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e="/#".concat(this.props.path);switch(this.props.openIn){case"same-window":return i.a.createElement("a",{href:e,target:"_parent"},this.props.children);case"new-tab":return i.a.createElement("a",{href:e,target:"_blank",rel:"noopener noreferrer"},this.props.children)}}}]),t}(i.a.Component),se=function(e){function t(){return Object(u.a)(this,t),Object(l.a)(this,Object(h.a)(t).apply(this,arguments))}return Object(d.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e="/narrative/".concat(this.props.narrativeID);return i.a.createElement("a",{href:e,target:"_blank",rel:"noopener noreferrer"},this.props.children)}}]),t}(i.a.Component),oe=function(e){function t(){return Object(u.a)(this,t),Object(l.a)(this,Object(h.a)(t).apply(this,arguments))}return Object(d.a)(t,e),Object(c.a)(t,[{key:"renderSubmitted",value:function(){var e=this.props.job.queuedAt;return e?i.a.createElement(p.NiceRelativeTime,{time:new Date(e)}):i.a.createElement("span",null,"** empty **")}},{key:"renderQueuedFor",value:function(){var e=this.props.job;switch(e.status){case y.QUEUED:return i.a.createElement(p.NiceElapsedTime,{from:e.queuedAt,precision:2,useClock:!0});case y.RUNNING:case y.FINISHED:return i.a.createElement(p.NiceElapsedTime,{from:e.queuedAt,to:e.runAt,precision:2});case y.CANCELED_QUEUED:return i.a.createElement(p.NiceElapsedTime,{from:e.queuedAt,to:e.finishAt,precision:2});case y.CANCELED_RUNNING:return i.a.createElement(p.NiceElapsedTime,{from:e.queuedAt,to:e.runAt,precision:2});case y.ERRORED_QUEUED:return i.a.createElement(p.NiceElapsedTime,{from:e.queuedAt,to:e.finishAt,precision:2});case y.ERRORED_RUNNING:return i.a.createElement(p.NiceElapsedTime,{from:e.queuedAt,to:e.runAt,precision:2})}}},{key:"renderRunFor",value:function(){var e=this.props.job;switch(e.status){case y.QUEUED:return i.a.createElement("span",null,"-");case y.RUNNING:return i.a.createElement(p.NiceElapsedTime,{from:e.runAt,precision:2,useClock:!0});case y.FINISHED:return i.a.createElement(p.NiceElapsedTime,{from:e.runAt,to:e.finishAt,precision:2});case y.CANCELED_QUEUED:return i.a.createElement("span",null,"-");case y.CANCELED_RUNNING:return i.a.createElement(p.NiceElapsedTime,{from:e.runAt,to:e.finishAt,precision:2});case y.ERRORED_QUEUED:return i.a.createElement("span",null,"-");case y.ERRORED_RUNNING:return i.a.createElement(p.NiceElapsedTime,{from:e.runAt,to:e.finishAt,precision:2})}}},{key:"renderStateSpinner",value:function(e){if(this.props.job.status===e)return i.a.createElement("span",null," ",i.a.createElement(_.a,{size:"small",style:{color:q(e)}}))}},{key:"renderNarrativeLink",value:function(){var e=this.props.job.narrativeID;if(null!==e)return i.a.createElement(se,{narrativeID:e},this.props.job.narrativeTitle)}},{key:"render",value:function(){return i.a.createElement("div",{className:"JobInfo InfoTable"},i.a.createElement("div",{className:"InfoTable-row"},i.a.createElement("div",{className:"InfoTable-labelCol"},"Job ID"),i.a.createElement("div",{className:"InfoTable-dataCol"},this.props.job.id)),i.a.createElement("div",{className:"InfoTable-row"},i.a.createElement("div",{className:"InfoTable-labelCol"},"Status"),i.a.createElement("div",{className:"InfoTable-dataCol"},i.a.createElement(B,{job:this.props.job}))),i.a.createElement("div",{className:"InfoTable-row"},i.a.createElement("div",{className:"InfoTable-labelCol"},"Narrative"),i.a.createElement("div",{className:"InfoTable-dataCol"},this.renderNarrativeLink())),i.a.createElement("div",{className:"InfoTable-row"},i.a.createElement("div",{className:"InfoTable-labelCol"},"App"),i.a.createElement("div",{className:"InfoTable-dataCol"},i.a.createElement(ie,{path:"catalog/apps/".concat(this.props.job.appID),openIn:"new-tab"},this.props.job.appTitle))),i.a.createElement("div",{className:"InfoTable-row"},i.a.createElement("div",{className:"InfoTable-labelCol"},"Submitted"),i.a.createElement("div",{className:"InfoTable-dataCol"},this.renderSubmitted())),i.a.createElement("div",{className:"InfoTable-row"},i.a.createElement("div",{className:"InfoTable-labelCol"},"Queued For"),i.a.createElement("div",{className:"InfoTable-dataCol"},this.renderQueuedFor(),this.renderStateSpinner(y.QUEUED))),i.a.createElement("div",{className:"InfoTable-row"},i.a.createElement("div",{className:"InfoTable-labelCol"},"Run For"),i.a.createElement("div",{className:"InfoTable-dataCol"},this.renderRunFor(),this.renderStateSpinner(y.RUNNING))))}}]),t}(i.a.Component),ue=(n(840),function(e){function t(){return Object(u.a)(this,t),Object(l.a)(this,Object(h.a)(t).apply(this,arguments))}return Object(d.a)(t,e),Object(c.a)(t,[{key:"renderLoading",value:function(){return i.a.createElement("div",{className:"FullyCenteredBox"},i.a.createElement("span",null,"Loading ... ",i.a.createElement(_.a,null)))}},{key:"renderQueued",value:function(){return i.a.createElement("div",{className:"FullyCenteredBox"},i.a.createElement("span",null,"The job is ",i.a.createElement("i",null,"queued"),". The log will be displayed when the job starts running ... ",i.a.createElement(_.a,null)))}},{key:"renderError",value:function(e){return i.a.createElement(O.a,{type:"error",message:e.error})}},{key:"renderJobLog",value:function(){switch(this.props.view.status){case De.NONE:case De.JOB_QUEUED:return this.renderQueued();case De.INITIAL_LOADING:return this.renderLoading();case De.ERROR:return this.renderError(this.props.view);case De.ACTIVE_LOADED:case De.ACTIVE_LOADING:case De.FINISHED_LOADED:return i.a.createElement(ae,{job:this.props.view.job,log:this.props.view.log})}}},{key:"renderJobInfo",value:function(){switch(this.props.view.status){case De.NONE:return this.renderLoading();case De.JOB_QUEUED:return i.a.createElement(oe,{job:this.props.view.job});case De.INITIAL_LOADING:return this.renderLoading();case De.ERROR:return this.renderError(this.props.view);case De.ACTIVE_LOADED:case De.ACTIVE_LOADING:case De.FINISHED_LOADED:return i.a.createElement(oe,{job:this.props.view.job})}}},{key:"renderTest",value:function(){var e=Array.from(Array(100).keys()).map((function(e){return i.a.createElement("div",{style:{flex:"0 0 auto",display:"flex",flexDirection:"row",borderBottom:"1px silver solid"},key:String(e)},i.a.createElement("div",{style:{flex:"0 0 auto",padding:"4px",overflowWrap:"break-word",wordWrap:"break-word"}},e))}));return i.a.createElement("div",{style:{flex:"1 1 0px",display:"flex",flexDirection:"column",minHeight:0}},i.a.createElement("div",null,"Header Here"),i.a.createElement("div",{style:{flex:"1 1 0px",display:"flex",flexDirection:"column",minHeight:0,overflowY:"auto"}},e))}},{key:"renderTest2",value:function(){var e=Array.from(Array(100).keys()).map((function(e){return i.a.createElement("div",{className:"FlexTable-row",key:String(e)},i.a.createElement("div",{className:"FlexTable-col"},e),i.a.createElement("div",{className:"FlexTable-col"},"This is row ",e))}));return i.a.createElement("div",{className:"FlexTable"},i.a.createElement("div",{className:"FlexTable-header"},i.a.createElement("div",{className:"FlexTable-row"},i.a.createElement("div",{className:"FlexTable-col"},"#"),i.a.createElement("div",{className:"FlexTable-col"},"Data"))),i.a.createElement("div",{className:"FlexTable-body"},e))}},{key:"renderStatus",value:function(){switch(this.props.view.status){case De.NONE:case De.INITIAL_LOADING:return i.a.createElement(_.a,{size:"small"});case De.ERROR:return i.a.createElement(O.a,{type:"error",message:this.props.view.error});default:return i.a.createElement(B,{job:this.props.view.job,showTiming:!0})}}},{key:"renderMiniDetails",value:function(){return i.a.createElement("div",{style:{flex:"0 0 auto"}},this.renderStatus())}},{key:"render",value:function(){var e=[{tab:"log",title:"Log",component:this.renderJobLog()},{tab:"detail",title:"Detail",component:this.renderJobInfo()}];return i.a.createElement(i.a.Fragment,null,this.renderMiniDetails(),i.a.createElement(K,{tabs:e}))}}]),t}(i.a.Component)),ce=n(57),le=n(285),he=n(163),de=n(112),me=function(){function e(t){Object(u.a)(this,e),this.queryMap={},"undefined"===typeof t&&(t={}),this.queryMap=t}return Object(c.a)(e,[{key:"addField",value:function(e,t){this.queryMap[e]=t}},{key:"removeField",value:function(e){delete this.queryMap[e]}},{key:"toString",value:function(){var e=this;return Object.keys(this.queryMap).map((function(t){return[t,e.queryMap[t]].map(encodeURIComponent).join("=")})).join("&")}}]),e}(),pe=function(){function e(t){Object(u.a)(this,e),this.header=void 0,"undefined"===typeof t?this.header={}:t instanceof XMLHttpRequest?this.header=e.fromXHR(t):this.header=e.fromMap(t)}return Object(c.a)(e,null,[{key:"fromXHR",value:function(e){var t=e.getAllResponseHeaders();if(!t)return{};var n=t.split(/\n/),r={};return n.forEach((function(e){var t=e.indexOf(":",0),n=e.substr(0,t).trim(),a=e.substr(t+1).trim();r[n.toLowerCase()]=a})),r}},{key:"fromMap",value:function(e){var t={};return Object.keys(e).forEach((function(n){t[n.toLowerCase()]=e[n]})),t}}]),Object(c.a)(e,[{key:"getHeader",value:function(e){return this.header[e.toLowerCase()]}},{key:"setHeader",value:function(e,t){this.header[e.toLowerCase()]=t}},{key:"exportHeader",value:function(e){var t=this;Object.keys(this.header).filter((function(e){return void 0!==t.getHeader(e)&&null!==t.getHeader(e)})).forEach((function(n){var r=function(e){switch(typeof e){case"string":return e;case"number":case"boolean":return String(e);default:throw new Error("Invalid type for header value: "+typeof e)}}(t.getHeader(n));e.setRequestHeader(n,r)}))}},{key:"getContentType",value:function(){var e=this.header["content-type"];if(!e)return null;var t=e.split(";").map((function(e){return e.trim()}));return t[1]?{mediaType:t[0],charset:t[1]}:{mediaType:t[0]}}}]),e}(),Ee=function(e){function t(e,n,r,a){var i;return Object(u.a)(this,t),(i=Object(l.a)(this,Object(h.a)(t).call(this,r))).timeout=void 0,i.elapsed=void 0,i.xhr=void 0,Object.setPrototypeOf(Object(de.a)(i),t.prototype),i.name="TimeoutError",i.stack=(new Error).stack,i.timeout=e,i.elapsed=n,i.xhr=a,i}return Object(d.a)(t,e),Object(c.a)(t,[{key:"toString",value:function(){return this.message}}]),t}(Object(he.a)(Error)),be=function(e){function t(e,n){var r;return Object(u.a)(this,t),(r=Object(l.a)(this,Object(h.a)(t).call(this,e))).xhr=void 0,Object.setPrototypeOf(Object(de.a)(r),t.prototype),r.name="GeneralError",r.stack=(new Error).stack,r.xhr=n,r}return Object(d.a)(t,e),Object(c.a)(t,[{key:"toString",value:function(){return this.message}}]),t}(Object(he.a)(Error)),fe=function(e){function t(e,n){var r;return Object(u.a)(this,t),(r=Object(l.a)(this,Object(h.a)(t).call(this,e))).xhr=void 0,Object.setPrototypeOf(Object(de.a)(r),t.prototype),r.name="AbortError",r.stack=(new Error).stack,r.xhr=n,r}return Object(d.a)(t,e),Object(c.a)(t,[{key:"toString",value:function(){return this.message}}]),t}(Object(he.a)(Error)),ve=function(){function e(){Object(u.a)(this,e)}return Object(c.a)(e,[{key:"request",value:function(e){var t;return Y.a.async((function(n){for(;;)switch(n.prev=n.next){case 0:return t=(new Date).getTime(),this,n.abrupt("return",new Promise((function(n,r){var a=new XMLHttpRequest;a.onload=function(){n({status:a.status,response:a.response,responseType:a.responseType,header:new pe(a)})},a.ontimeout=function(){var n=(new Date).getTime()-t;r(new Ee(e.timeout,n,"Request timeout",a))},a.onerror=function(){r(new be("General request error "+e.url,a))},a.onabort=function(){r(new fe("Request was aborted",a))};var i=e.url;e.query&&(i+="?"+new me(e.query).toString());var s=e.responseType||"text";a.responseType=s;try{a.open(e.method,i,!0)}catch(o){return void r(new be("Error opening request "+o.name,a))}e.timeout&&(a.timeout=e.timeout),a.withCredentials=e.withCredentials||!1;try{e.header&&e.header.exportHeader(a)}catch(o){r(new be("Error applying header before send "+o.name,a))}try{"string"===typeof e.data?(a.send(e.data),e.onCancel&&e.onCancel((function(){a.abort()}))):e.data instanceof Array?a.send(new Uint8Array(e.data)):"undefined"===typeof e.data?a.send():null===e.data?a.send():r(new Error("Invalid type of data to send: "+typeof e.data))}catch(o){r(new be("Error sending data in request",a))}})));case 3:case"end":return n.stop()}}),null,this)}}]),e}(),ye=n(125),Se=n.n(ye),Re=function(e){function t(e){var n;return Object(u.a)(this,t),(n=Object(l.a)(this,Object(h.a)(t).call(this,e.message))).error=void 0,n.error=e,n}return Object(d.a)(t,e),t}(Object(he.a)(Error)),ge=function(){function e(t){var n=t.url,r=t.timeout,a=t.authorization;Object(u.a)(this,e),this.url=void 0,this.timeout=void 0,this.authorization=void 0,this.url=n,this.timeout=r,this.authorization=a}return Object(c.a)(e,[{key:"isGeneralError",value:function(e){return e instanceof be}},{key:"makePayload",value:function(e,t){return{version:"1.1",method:e,id:Se.a.v4(),params:t}}},{key:"callMethod",value:function(e,t){var n,r,a,i,s,o,u=arguments;return Y.a.async((function(c){for(;;)switch(c.prev=c.next){case 0:return n=u.length>2&&void 0!==u[2]?u[2]:{},r=n.timeout,a=this.makePayload(e,t),(i=new pe).setHeader("content-type","application/json"),i.setHeader("accept","application/json"),this.authorization&&i.setHeader("authorization",this.authorization),s={method:"POST",url:this.url,timeout:r||this.timeout,data:JSON.stringify(a),header:i},o=new ve,c.abrupt("return",o.request(s).then((function(e){var t;try{t=JSON.parse(e.response)}catch(r){throw new Re({name:"parse error",code:100,message:"The response from the service could not be parsed",error:{originalMessage:r.message,responseText:e.response}})}if(t.hasOwnProperty("error")){var n=t;throw new Re({name:n.error.name,code:n.error.code,message:n.error.message,error:n.error.error})}return t.result})));case 9:case"end":return c.stop()}}),null,this)}}]),e}(),we=function(){function e(t){var n=t.url,r=t.timeout,a=t.authorization;Object(u.a)(this,e),this.module=void 0,this.url=void 0,this.timeout=void 0,this.authorization=void 0,this.url=n,this.timeout=r,this.authorization=a}return Object(c.a)(e,[{key:"callFunc",value:function(e,t){var n,r,a;return Y.a.async((function(i){for(;;)switch(i.prev=i.next){case 0:return n=new ge({url:this.url,timeout:this.timeout,authorization:this.authorization}),r=this.module+"."+e,i.next=4,Y.a.awrap(n.callMethod(r,[t],{timeout:this.timeout}));case 4:if(0!==(a=i.sent).length){i.next=7;break}throw new Error("Too few (none) return values in return array");case 7:return i.abrupt("return",a[0]);case 8:case"end":return i.stop()}}),null,this)}},{key:"callFuncEmptyResult",value:function(e,t){var n,r,a;return Y.a.async((function(i){for(;;)switch(i.prev=i.next){case 0:return n=new ge({url:this.url,timeout:this.timeout,authorization:this.authorization}),r=this.module+"."+e,i.next=4,Y.a.awrap(n.callMethod(r,[t],{timeout:this.timeout}));case 4:if(0===(a=i.sent).length){i.next=7;break}throw new Error("Too many (".concat(a.length,") return values in return array"));case 7:return i.abrupt("return");case 8:case"end":return i.stop()}}),null,this)}}]),e}();function Ne(e,t){return!("object"!==typeof e||!Reflect.has(e,t)||"string"!==typeof Reflect.get(e,t))}function Ce(e){return!!(Ne(e,"module_name")&&Ne(e,"version")&&Ne(e,"git_commit_hash")&&function(e,t,n){if("object"===typeof e&&Reflect.has(e,t)){var r=Reflect.get(e,t);if("object"===typeof r&&r instanceof Array)return 0===r.length||r.every((function(e){return"string"===typeof e}))}return!1}(e,"release_tags")&&Ne(e,"url")&&function(e,t){return!("object"!==typeof e||!Reflect.has(e,t)||"number"!==typeof Reflect.get(e,t))}(e,"up")&&Ne(e,"status")&&Ne(e,"health"))}var ke,Oe=function(e){function t(){var e,n;Object(u.a)(this,t);for(var r=arguments.length,a=new Array(r),i=0;i<r;i++)a[i]=arguments[i];return(n=Object(l.a)(this,(e=Object(h.a)(t)).call.apply(e,[this].concat(a)))).module="ServiceWizard",n}return Object(d.a)(t,e),Object(c.a)(t,[{key:"getServiceStatus",value:function(e){var t;return Y.a.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,Y.a.awrap(this.callFunc("get_service_status",e));case 2:if(t=n.sent){n.next=5;break}throw new Error("Crazy as it seems, result is falsy");case 5:if(!Ce(t)){n.next=9;break}return n.abrupt("return",t);case 9:throw new Error('Sorry, result does not conform to "GetServiceStatusResult"');case 10:case"end":return n.stop()}}),null,this)}}]),t}(we);!function(e){e[e.RESERVED=0]="RESERVED",e[e.PRESENT=1]="PRESENT"}(ke||(ke={}));var _e=new(function(){function e(t){var n=t.itemLifetime,r=t.monitoringFrequency,a=t.waiterTimeout,i=t.waiterFrequency;Object(u.a)(this,e),this.cache=void 0,this.cacheLifetime=void 0,this.monitoringFrequency=void 0,this.waiterTimeout=void 0,this.waiterFrequency=void 0,this.isMonitoring=void 0,this.cache=new Map,this.cacheLifetime=n||18e5,this.monitoringFrequency=r||6e4,this.waiterTimeout=a||3e4,this.waiterFrequency=i||100,this.isMonitoring=!1}return Object(c.a)(e,[{key:"runMonitor",value:function(){var e=this;this.isMonitoring||(this.isMonitoring=!0,setTimeout((function(){var t=new Map,n=!1;Object.keys(e.cache).forEach((function(r){var a=e.cache.get(r);e.isExpired(a)||(t.set(r,a),n=!0)})),e.cache=t,e.isMonitoring=!1,n&&e.runMonitor()}),this.monitoringFrequency))}},{key:"isExpired",value:function(e){return(new Date).getTime()-e.createdAt>this.cacheLifetime}},{key:"getItem",value:function(e){if(void 0===this.cache.get(e))return null;var t=this.cache.get(e);if(!this.isExpired(t))return t;this.cache.delete(e)}},{key:"reserveWaiter",value:function(e,t){var n=this;return Y.a.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",new Promise((function(r,a){var i=(new Date).getTime(),s=function(){var s,u;return Y.a.async((function(c){for(;;)switch(c.prev=c.next){case 0:if("undefined"!==typeof(s=n.cache.get(e))){c.next=5;break}return c.next=4,Y.a.awrap(n.reserveAndFetch(e,t));case 4:return c.abrupt("return",c.sent);case 5:c.t0=s.state,c.next=c.t0===ke.RESERVED?8:c.t0===ke.PRESENT?11:12;break;case 8:return(u=(new Date).getTime()-i)<n.waiterTimeout?o():a(new Error("Timed-out waiting for cache item to become available; timeout ".concat(n.waiterTimeout,", waited ").concat(u))),c.abrupt("break",12);case 11:r(s);case 12:case"end":return c.stop()}}))},o=function(){return Y.a.async((function(e){for(;;)switch(e.prev=e.next){case 0:setTimeout(s,n.waiterFrequency);case 1:case"end":return e.stop()}}))};o()})));case 1:case"end":return r.stop()}}))}},{key:"reserveAndFetch",value:function(e,t){var n,r;return Y.a.async((function(a){for(;;)switch(a.prev=a.next){case 0:return this.reserveItem(e,t),a.next=3,Y.a.awrap(t());case 3:return n=a.sent,r={id:e,fetcher:t,createdAt:(new Date).getTime(),value:n,state:ke.PRESENT},this.cache.set(e,r),this.runMonitor(),a.abrupt("return",n);case 8:case"end":return a.stop()}}),null,this)}},{key:"getItemWithWait",value:function(e){var t,n,r;return Y.a.async((function(a){for(;;)switch(a.prev=a.next){case 0:if(t=e.id,n=e.fetcher,"undefined"!==typeof(r=this.cache.get(t))){a.next=4;break}return a.abrupt("return",this.reserveAndFetch(t,n));case 4:if(!this.isExpired(r)){a.next=7;break}return this.cache.delete(t),a.abrupt("return",this.reserveAndFetch(t,n));case 7:a.t0=r.state,a.next=a.t0===ke.RESERVED?10:a.t0===ke.PRESENT?13:14;break;case 10:return a.next=12,Y.a.awrap(this.reserveWaiter(t,n));case 12:return a.abrupt("return",a.sent.value);case 13:return a.abrupt("return",r.value);case 14:case"end":return a.stop()}}),null,this)}},{key:"reserveItem",value:function(e,t){var n={id:e,fetcher:t,reservedAt:(new Date).getTime(),state:ke.RESERVED};return this.cache.set(e,n),n}}]),e}())({itemLifetime:18e5,monitoringFrequency:6e4,waiterTimeout:3e4,waiterFrequency:100}),Ae=function(e){function t(e){var n;return Object(u.a)(this,t),(n=Object(l.a)(this,Object(h.a)(t).call(this,e))).module="kb_Metrics",n}return Object(d.a)(t,e),Object(c.a)(t,[{key:"getJobs",value:function(e){var t,n;return Y.a.async((function(r){for(;;)switch(r.prev=r.next){case 0:return t=e.epoch_range,n=e.user_ids,r.abrupt("return",this.callFunc("get_jobs",{epoch_range:t,user_ids:n}));case 2:case"end":return r.stop()}}),null,this)}},{key:"getJob",value:function(e){var t;return Y.a.async((function(n){for(;;)switch(n.prev=n.next){case 0:return t=e.job_id,n.abrupt("return",this.callFunc("get_job",{job_id:t}));case 2:case"end":return n.stop()}}),null,this)}},{key:"getAppMetrics",value:function(e){var t,n;return Y.a.async((function(r){for(;;)switch(r.prev=r.next){case 0:return t=e.epoch_range,n=e.user_ids,r.next=3,Y.a.awrap(this.callFunc("get_job",{epoch_range:t,user_ids:n}));case 3:return r.abrupt("return",r.sent);case 4:case"end":return r.stop()}}),null,this)}}]),t}(function(e){function t(e){var n;Object(u.a)(this,t),(n=Object(l.a)(this,Object(h.a)(t).call(this,e))).version=void 0,n.module=void 0,n.serviceDiscoveryURL=void 0,n.serviceDiscoveryModule="ServiceWizard";var r=e.version;return n.version=r||null,"auto"===n.version&&(n.version=null),n.serviceDiscoveryURL=e.url,n}return Object(d.a)(t,e),Object(c.a)(t,[{key:"moduleId",value:function(){var e;return e=this.version?this.module+":"+this.version:this.module+":auto",e}},{key:"getCached",value:function(e){return _e.getItemWithWait({id:this.moduleId(),fetcher:e})}},{key:"lookupModule",value:function(){var e,t=this;return Y.a.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,Y.a.awrap(this.getCached((function(){var e=new Oe({url:t.serviceDiscoveryURL,authorization:t.authorization,timeout:t.timeout});return Promise.resolve(e.getServiceStatus({module_name:t.module,version:t.version}))})));case 2:return e=n.sent,this.module=e.module_name,this.url=e.url,n.abrupt("return",e);case 6:case"end":return n.stop()}}),null,this)}},{key:"callFunc",value:function(e,n){return Y.a.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,Y.a.awrap(this.lookupModule());case 2:return r.abrupt("return",Object(le.a)(Object(h.a)(t.prototype),"callFunc",this).call(this,e,n));case 3:case"end":return r.stop()}}),null,this)}},{key:"callFuncEmptyResult",value:function(e,n){return Y.a.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,Y.a.awrap(this.lookupModule());case 2:return r.abrupt("return",Object(le.a)(Object(h.a)(t.prototype),"callFuncEmptyResult",this).call(this,e,n));case 3:case"end":return r.stop()}}),null,this)}}]),t}(we));function Te(e,t){switch(function(e){switch(e.state){case"QUEUED":return y.QUEUED;case"RUNNING":return y.RUNNING;case"FINISHED":return y.FINISHED;case"CANCELED_QUEUED":case"CANCELED_RUNNING":return y.CANCELED_QUEUED;case"ERRORED_QUEUED":return y.ERRORED_QUEUED;case"ERRORED_RUNNING":return y.ERRORED_RUNNING;default:throw new Error("Unknown job state: "+e.state)}}(e)){case y.QUEUED:return function(e,t){var n;return n=e.wsid?parseInt(e.wsid,10):null,{key:e.job_id,id:e.job_id,status:y.QUEUED,appID:e.app_id,appTitle:e.app_id,narrativeID:n,narrativeTitle:e.narrative_name,queuedAt:e.creation_time,queuedElapsed:Date.now()-e.creation_time,clientGroups:e.client_groups,username:e.user||t}}(e,t);case y.RUNNING:return function(e,t){var n;if(n=e.wsid?parseInt(e.wsid,10):null,!e.exec_start_time)throw console.error("ERROR: Running job without exec_start_time!",e),new Error("Running job without exec_start_time!");return{key:e.job_id,id:e.job_id,status:y.RUNNING,appID:e.app_id,appTitle:e.app_id,narrativeID:n,narrativeTitle:e.narrative_name,queuedAt:e.creation_time,runAt:e.exec_start_time,runElapsed:Date.now()-e.exec_start_time,queuedElapsed:Date.now()-e.creation_time,clientGroups:e.client_groups,username:e.user||t}}(e,t);case y.FINISHED:return function(e,t){var n;if(n=e.wsid?parseInt(e.wsid,10):null,!e.exec_start_time)throw new Error("Running job without exec_start_time!");if(!e.finish_time)throw new Error("Running job without finish_time!");return{key:e.job_id,id:e.job_id,status:y.FINISHED,appID:e.app_id,appTitle:e.app_id,narrativeID:n,narrativeTitle:e.narrative_name,queuedAt:e.creation_time,runAt:e.exec_start_time,runElapsed:e.finish_time-e.exec_start_time,finishAt:e.finish_time,queuedElapsed:Date.now()-e.creation_time,clientGroups:e.client_groups,username:e.user||t}}(e,t);case y.ERRORED_QUEUED:return function(e,t){var n;if(n=e.wsid?parseInt(e.wsid,10):null,!e.finish_time)throw new Error("Errored job without finish_time!");return{key:e.job_id,id:e.job_id,status:y.ERRORED_QUEUED,appID:e.app_id,appTitle:e.app_id,narrativeID:n,narrativeTitle:e.narrative_name,queuedAt:e.creation_time,finishAt:e.finish_time,queuedElapsed:e.finish_time-e.creation_time,clientGroups:e.client_groups,message:e.status,username:e.user||t}}(e,t);case y.ERRORED_RUNNING:return function(e,t){var n;if(n=e.wsid?parseInt(e.wsid,10):null,!e.exec_start_time)throw console.error("ERROR: Errored job without exec_start_time!",e),new Error("Errored job without exec_start_time!");if(!e.finish_time)throw new Error("Errored job without finish_time!");return{key:e.job_id,id:e.job_id,status:y.ERRORED_RUNNING,appID:e.app_id,appTitle:e.app_id,narrativeID:n,narrativeTitle:e.narrative_name,queuedAt:e.creation_time,runAt:e.exec_start_time,runElapsed:e.finish_time-e.exec_start_time,finishAt:e.finish_time,queuedElapsed:e.exec_start_time-e.creation_time,clientGroups:e.client_groups,message:e.status,username:e.user||t}}(e,t);case y.CANCELED_QUEUED:return function(e,t){var n;if(n=e.wsid?parseInt(e.wsid,10):null,!e.finish_time)throw new Error("Canceled job without finish_time!");return{key:e.job_id,id:e.job_id,status:y.CANCELED_QUEUED,appID:e.app_id,appTitle:e.app_id,narrativeID:n,narrativeTitle:e.narrative_name,queuedAt:e.creation_time,queuedElapsed:Date.now()-e.creation_time,clientGroups:e.client_groups,finishAt:e.finish_time,username:e.user||t}}(e,t);case y.CANCELED_RUNNING:return function(e,t){var n;if(n=e.wsid?parseInt(e.wsid,10):null,!e.exec_start_time)throw new Error("Canceled job without exec_start_time!");if(!e.finish_time)throw new Error("Canceled job without finish_time!");return{key:e.job_id,id:e.job_id,status:y.CANCELED_RUNNING,appID:e.app_id,appTitle:e.app_id,narrativeID:n,narrativeTitle:e.narrative_name,queuedAt:e.creation_time,runAt:e.exec_start_time,runElapsed:e.finish_time-e.exec_start_time,finishAt:e.finish_time,queuedElapsed:Date.now()-e.creation_time,clientGroups:e.client_groups,username:e.user||t}}(e,t);default:throw new Error("Invalid job status: "+e.status)}}function Ie(e,t){return!t||t.some((function(t){return e.status===t}))}function je(e){switch(e.kind){case"preset":return function(e){var t=(new Date).getTime();switch(e){case"lastHour":return[t-36e5,t];case"last48Hours":return[t-1728e5,t];case"lastWeek":return[t-6048e5,t];case"lastMonth":return[t-2592e6,t]}}(e.preset);case"literal":return[e.start,e.end];default:throw new Error("Invalid time range kind value (should be impossible")}}var De;!function(e){e[e.NONE=0]="NONE",e[e.JOB_QUEUED=1]="JOB_QUEUED",e[e.INITIAL_LOADING=2]="INITIAL_LOADING",e[e.ACTIVE_LOADED=3]="ACTIVE_LOADED",e[e.ACTIVE_LOADING=4]="ACTIVE_LOADING",e[e.FINISHED_LOADED=5]="FINISHED_LOADED",e[e.ERROR=6]="ERROR"}(De||(De={}));var Ue=function(e){function t(e){var n;return Object(u.a)(this,t),(n=Object(l.a)(this,Object(h.a)(t).call(this,e))).state={status:De.NONE},n}return Object(d.a)(t,e),Object(c.a)(t,[{key:"getJob",value:function(){var e,t,n;return Y.a.async((function(r){for(;;)switch(r.prev=r.next){case 0:return e=new Ae({authorization:this.props.token,url:this.props.serviceWizardURL,timeout:1e4}),t=this.props.jobID,r.next=4,Y.a.awrap(e.getJob({job_id:t}));case 4:return n=r.sent,r.abrupt("return",Te(n.job_state,"UNKNOWN"));case 6:case"end":return r.stop()}}),null,this)}},{key:"getJobLog",value:function(e){var t,n,r,a;return Y.a.async((function(i){for(;;)switch(i.prev=i.next){case 0:return t=new ce.NarrativeJobServiceClient({token:this.props.token,url:this.props.njsURL,module:"NarrativeJobService"}),i.next=3,Y.a.awrap(t.getJobLogs({job_id:this.props.jobID,skip_lines:e}));case 3:return n=i.sent,r=Object(V.a)(n,1),a=r[0],i.abrupt("return",a.lines.map((function(t,n){return{lineNumber:e+n+1,line:t.line,isError:!!t.is_error}})));case 7:case"end":return i.stop()}}),null,this)}},{key:"startRunningPolling",value:function(){var e=this,t=function(){var t,r,a,i,s;return Y.a.async((function(o){for(;;)switch(o.prev=o.next){case 0:if((t=e.state).status===De.ACTIVE_LOADED){o.next=4;break}return e.setState({status:De.ERROR,error:"Invalid state for polling: "+t.status}),o.abrupt("return");case 4:return r=t.log,e.setState({status:De.ACTIVE_LOADING,log:r}),o.next=8,Y.a.awrap(e.getJob());case 8:return a=o.sent,i=r.length,o.next=12,Y.a.awrap(e.getJobLog(i));case 12:s=o.sent,o.t0=a.status,o.next=o.t0===y.QUEUED?16:o.t0===y.RUNNING?18:o.t0===y.FINISHED?21:o.t0===y.ERRORED_QUEUED?21:o.t0===y.ERRORED_RUNNING?21:o.t0===y.CANCELED_RUNNING?21:o.t0===y.CANCELED_QUEUED?21:22;break;case 16:return e.startQueuedPolling(),o.abrupt("break",22);case 18:return e.setState({status:De.ACTIVE_LOADED,log:r.concat(s),job:a}),n(),o.abrupt("break",22);case 21:e.setState({status:De.FINISHED_LOADED,log:r.concat(s),job:a});case 22:case"end":return o.stop()}}))},n=function(){setTimeout(t,5e3)};n()}},{key:"startQueuedPolling",value:function(){var e=this,t=function(){var t,r;return Y.a.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,a.next=3,Y.a.awrap(e.getJob());case 3:t=a.sent,a.t0=t.status,a.next=a.t0===y.QUEUED?7:9;break;case 7:return n(),a.abrupt("return");case 9:return a.next=11,Y.a.awrap(e.getJobLog(0));case 11:r=a.sent,a.t1=t.status,a.next=a.t1===y.RUNNING?15:a.t1===y.FINISHED?18:a.t1===y.CANCELED_QUEUED?20:a.t1===y.CANCELED_RUNNING?20:a.t1===y.ERRORED_QUEUED?22:a.t1===y.ERRORED_RUNNING?22:24;break;case 15:return e.setState({status:De.ACTIVE_LOADED,log:r,job:t}),e.startRunningPolling(),a.abrupt("break",24);case 18:return e.setState({status:De.FINISHED_LOADED,log:r,job:t}),a.abrupt("break",24);case 20:return e.setState({status:De.FINISHED_LOADED,log:r,job:t}),a.abrupt("break",24);case 22:return e.setState({status:De.ERROR,log:r,job:t}),a.abrupt("break",24);case 24:a.next=29;break;case 26:a.prev=26,a.t2=a.catch(0),console.error("ERROR",a.t2);case 29:case"end":return a.stop()}}),null,null,[[0,26]])},n=function(){setTimeout(t,5e3)};n()}},{key:"getInitialJobLog",value:function(){var e,t;return Y.a.async((function(n){for(;;)switch(n.prev=n.next){case 0:return this.setState({status:De.INITIAL_LOADING}),n.next=3,Y.a.awrap(this.getJob());case 3:e=n.sent,n.t0=e.status,n.next=n.t0===y.QUEUED?7:n.t0===y.RUNNING?10:n.t0===y.FINISHED?16:n.t0===y.ERRORED_QUEUED?16:n.t0===y.ERRORED_RUNNING?16:n.t0===y.CANCELED_QUEUED?16:n.t0===y.CANCELED_RUNNING?16:21;break;case 7:return this.setState({status:De.JOB_QUEUED,job:e}),this.startQueuedPolling(),n.abrupt("return");case 10:return n.next=12,Y.a.awrap(this.getJobLog(0));case 12:return t=n.sent,this.setState({status:De.ACTIVE_LOADED,log:t,job:e}),this.startRunningPolling(),n.abrupt("return");case 16:return n.next=18,Y.a.awrap(this.getJobLog(0));case 18:return t=n.sent,this.setState({status:De.FINISHED_LOADED,log:t,job:e}),n.abrupt("return");case 21:case"end":return n.stop()}}),null,this)}},{key:"componentDidMount",value:function(){this.getInitialJobLog()}},{key:"renderLoading",value:function(){return i.a.createElement("div",null,"Loading ... ",i.a.createElement(_.a,null))}},{key:"renderQueued",value:function(){return i.a.createElement("div",null,"Queued ... ",i.a.createElement(_.a,null))}},{key:"renderError",value:function(e){return i.a.createElement(O.a,{type:"error",message:e.error})}},{key:"render",value:function(){return i.a.createElement(ue,{view:this.state})}}]),t}(i.a.Component);var xe,Le=Object(k.connect)((function(e,t){var n=e.auth.userAuthorization,r=e.app.config.services,a=r.NarrativeJobService.url,i=r.ServiceWizard.url;if(!n)throw new Error("Invalid state: token required");return{token:n.token,njsURL:a,serviceWizardURL:i}}),(function(e,t){return{}}))(Ue),Je=(n(841),n(388),n(99)),Pe=function(){function e(t){Object(u.a)(this,e),this.subscriptions=void 0,this.pubsub=void 0,this.subscriptions=[],this.pubsub=t}return Object(c.a)(e,[{key:"on",value:function(e,t){var n=this.pubsub.on(e,t);this.subscriptions.push(n)}},{key:"off",value:function(){var e=this;this.subscriptions.forEach((function(t){e.pubsub.off(t)}))}}]),e}(),Fe=function(){function e(){Object(u.a)(this,e),this.sendQueue=void 0,this.messageListeners=void 0,this.allListeners=void 0,this.sendQueue=[],this.messageListeners=new Map,this.allListeners=new Map}return Object(c.a)(e,[{key:"sendMessages",value:function(){var e=this,t=this.sendQueue;this.sendQueue=[],t.forEach((function(t){var n=e.messageListeners.get(t.id);n&&n.listeners.forEach((function(e){try{e.handler(t.payload)}catch(n){console.error("ERROR",n)}}))}))}},{key:"processQueue",value:function(){var e=this;0!==this.sendQueue.length&&window.setTimeout((function(){e.sendMessages()}),1e3/60)}},{key:"send",value:function(e,t){var n={id:e,payload:t};this.sendQueue.push(n),this.processQueue()}},{key:"on",value:function(e,t){var n=this.messageListeners.get(e);n||(n={listeners:[]},this.messageListeners.set(e,n));var r=Se.a.v4(),a={id:r,messageID:e,handler:t};return n.listeners.push(a),this.allListeners.set(r,a),r}},{key:"off",value:function(e){var t=this.allListeners.get(e);if(t){var n=this.messageListeners.get(t.messageID);n&&(n.listeners=n.listeners.filter((function(e){return e.id!==t.id})))}}}]),e}();!function(e){e[e.STARTED=0]="STARTED",e[e.POLLING=1]="POLLING",e[e.WAITING=2]="WAITING",e[e.PAUSED=3]="PAUSED",e[e.STOPPED=4]="STOPPED",e[e.ERROR=5]="ERROR"}(xe||(xe={}));var Me=function(){function e(t){Object(u.a)(this,e),this.params=void 0,this.statusTimer=void 0,this.statusCount=void 0,this.watchStartAt=void 0,this.status=void 0,this.error=void 0,this.watcherTimer=void 0,this.waitTimer=void 0,this.pubsubProxy=void 0,this.params=t,this.statusTimer=null,this.statusCount=0,this.watchStartAt=0,this.status=xe.STOPPED,this.watcherTimer=null,this.waitTimer=null,this.pubsubProxy=new Pe(this.params.pubsub),this.error=""}return Object(c.a)(e,[{key:"stop",value:function(){this.pubsubProxy.off()}},{key:"pause",value:function(){this.status=xe.PAUSED,this.waitTimer&&window.clearInterval(this.waitTimer),this.statusTimer&&window.clearInterval(this.statusTimer),this.watcherTimer&&window.clearTimeout(this.watcherTimer),this.statusCount=0,this.updateOnProgress()}},{key:"play",value:function(){this.startWaiting()}},{key:"startWatching",value:function(){var e=this;this.watchStartAt=Date.now(),this.status=xe.STARTED;var t=function(){var t=Date.now()-e.watchStartAt;if(t>1e4)return e.status=xe.ERROR,e.error="Polling took too long (".concat(t,"ms)"),void e.stopPolling();switch(e.status){case xe.STARTED:case xe.POLLING:return void n();case xe.WAITING:e.watcherTimer&&window.clearTimeout(e.watcherTimer),e.status=xe.WAITING,e.startWaiting();break;case xe.STOPPED:n();break;case xe.PAUSED:console.warn("unexpected state PAUSED");break;case xe.ERROR:console.warn("unexpected state ERROR")}},n=function(){e.watcherTimer=window.setTimeout(t,e.params.watchInterval)};n()}},{key:"startWaiting",value:function(){var e=this;this.status=xe.WAITING;var t=function(){e.statusTimer=window.setInterval((function(){e.statusCount+=1,e.updateOnProgress()}),e.params.pollInterval/e.params.progressSteps)};e.waitTimer=window.setTimeout(e.runPoll.bind(e),e.params.pollInterval),e.statusCount=0,t()}},{key:"runPoll",value:function(){this.statusTimer&&window.clearInterval(this.statusTimer),this.params.onPoll(),this.statusCount=0,this.startWatching()}},{key:"startListeningForPollingEvent",value:function(){var e=this;this.pubsubProxy.on("searching",(function(t){if(t.is)switch(e.status){case xe.STARTED:e.status=xe.POLLING;break;case xe.POLLING:break;case xe.WAITING:e.pause();break;case xe.STOPPED:case xe.PAUSED:case xe.ERROR:}else switch(e.status){case xe.STARTED:break;case xe.POLLING:e.status=xe.WAITING;break;case xe.WAITING:case xe.STOPPED:break;case xe.PAUSED:e.play();break;case xe.ERROR:}}))}},{key:"stopListeningForPollingEvent",value:function(){this.pubsubProxy.off()}},{key:"startPolling",value:function(){this.startListeningForPollingEvent(),this.runPoll()}},{key:"updateOnProgress",value:function(){this.params.onProgress(100*this.statusCount/this.params.progressSteps)}},{key:"stopPolling",value:function(){this.waitTimer&&window.clearInterval(this.waitTimer),this.statusTimer&&window.clearInterval(this.statusTimer),this.watcherTimer&&window.clearTimeout(this.watcherTimer),this.statusCount=0,this.updateOnProgress(),this.stopListeningForPollingEvent()}}]),e}(),Qe=1e4,Ge=100,He=100,qe=function(e){function t(e){var n;return Object(u.a)(this,t),(n=Object(l.a)(this,Object(h.a)(t).call(this,e))).monitoringTimer=void 0,n.monitoringStatusTimer=void 0,n.pollWatcherTimer=void 0,n.searchListenerID=void 0,n.pubsubProxy=void 0,n.poller=void 0,n.monitoringTimer=null,n.monitoringStatusTimer=null,n.pollWatcherTimer=null,n.searchListenerID=null,n.pubsubProxy=new Pe(n.props.pubsub),n.poller=new Me({onPoll:n.props.onPoll,onProgress:n.onProgress.bind(Object(de.a)(n)),pubsub:n.props.pubsub,pollInterval:Qe,progressSteps:Ge,watchInterval:He}),n.state={isMonitoring:!1,pollWaitProgress:0,isPollingInitiated:!1,pollingStartedAt:0,isPolling:!1,isOpen:n.props.startOpen},n}return Object(d.a)(t,e),Object(c.a)(t,[{key:"onProgress",value:function(e){this.setState({pollWaitProgress:e})}},{key:"componentDidMount",value:function(){var e=this;this.props.startPolling&&this.startMonitoring(),this.pubsubProxy.on("searching",(function(t){t.is?e.setState({isPolling:!0}):e.setState({isPolling:!1})}))}},{key:"componentWillUnmount",value:function(){this.stopMonitoring(),this.poller.stop(),this.pubsubProxy.off()}},{key:"componentDidUpdate",value:function(){}},{key:"startMonitoring",value:function(){this.setState({isMonitoring:!0}),this.poller.startPolling()}},{key:"stopMonitoring",value:function(){this.poller.stopPolling(),this.setState({isMonitoring:!1})}},{key:"toggleMonitoring",value:function(){this.state.isMonitoring?this.stopMonitoring():this.startMonitoring()}},{key:"onToggleOpen",value:function(e){this.setState({isOpen:e})}},{key:"render",value:function(){if(!this.props.showControls)return null;var e,t,n,r="Start Polling",i="default",s=a.createElement(U.a,{defaultChecked:this.state.isOpen,checkedChildren:"hide monitor",unCheckedChildren:"show monitor",onChange:this.onToggleOpen.bind(this)});return this.state.isMonitoring&&(r="Stop Polling",i="danger",e=this.state.isPolling?a.createElement("span",null," ",a.createElement(Je.a,{type:"circle",percent:100,width:30,showInfo:!1,strokeWidth:30,strokeColor:"orange"})):a.createElement("span",null," ",a.createElement(Je.a,{type:"circle",percent:this.state.pollWaitProgress,width:30,strokeWidth:30,showInfo:!1}))),t=this.state.isMonitoring?"Polling is running, with an interval of ".concat(Qe,"ms and ").concat(Ge," update steps."):"Polling is currently stopped.",this.state.isOpen&&(n=a.createElement(I.a,{title:t},a.createElement(M.a,{onClick:this.toggleMonitoring.bind(this),type:i,size:"small",style:{fontSize:"80%"}},r),e)),a.createElement("span",null,s," ",n)}}]),t}(a.Component),ze=[{label:"Queued",value:"queued"},{label:"Running",value:"running"},{label:"Canceled",value:"canceled"},{label:"Success",value:"success"},{label:"Error",value:"error"}];var Be=function(e){function t(e){var n;return Object(u.a)(this,t),(n=Object(l.a)(this,Object(h.a)(t).call(this,e))).currentQuery=void 0,n.pubsub=void 0,n.currentQuery="",n.pubsub=new Fe,n.state={showDates:!1,currentJobStatusFilter:["queued","running","canceled","success","error"],timeRange:{kind:"preset",preset:t.defaultTimeRange},isFilterOpen:!1,selectedJob:null,currentSort:null},n}return Object(d.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.doSearch(!0)}},{key:"componentDidUpdate",value:function(){this.props.searchState===S.SEARCHING?this.pubsub.send("searching",{is:!0}):this.pubsub.send("searching",{is:!1})}},{key:"onChangeTimeRange",value:function(e){var t=this;"customRange"!==e?this.setState({showDates:!1,timeRange:{kind:"preset",preset:e}},(function(){t.doSearch(!0)})):this.setState({showDates:!0,timeRange:{kind:"literal",start:Date.now(),end:Date.now()}})}},{key:"onChangeQuery",value:function(e){this.currentQuery=e.target.value}},{key:"onSubmit",value:function(e){e.preventDefault(),this.doSearch(!0)}},{key:"doSearch",value:function(e){if("undefined"!==typeof this.currentQuery){var t=function(e){var t=[];return e.forEach((function(e){switch(e){case"queued":t.push(y.QUEUED);break;case"running":t.push(y.RUNNING);break;case"canceled":t.push(y.CANCELED_QUEUED),t.push(y.CANCELED_RUNNING);break;case"success":t.push(y.FINISHED);break;case"error":t.push(y.ERRORED_QUEUED),t.push(y.ERRORED_RUNNING)}})),t}(this.state.currentJobStatusFilter),n={query:this.currentQuery,timeRange:this.state.timeRange,jobStatus:t,forceSearch:e,sort:this.state.currentSort};return this.pubsub.send("search",{}),this.props.search(n),!1}}},{key:"onRangeFromChange",value:function(e,t){if(null!==e){var n,r=this.state.timeRange;switch(r.kind){case"preset":n={kind:"literal",start:e.valueOf(),end:1/0};break;case"literal":n={kind:"literal",start:e.valueOf(),end:r.end};break;default:return}this.setState({timeRange:n})}else this.setState({timeRange:{kind:"preset",preset:"lastHour"}})}},{key:"onRangeToChange",value:function(e,t){if(null!==e){var n,r=this.state.timeRange;switch(r.kind){case"preset":n={kind:"literal",start:1/0,end:e.valueOf()};break;case"literal":n={kind:"literal",start:r.start,end:e.valueOf()};break;default:return}this.setState({timeRange:n})}else this.setState({timeRange:{kind:"preset",preset:"lastHour"}})}},{key:"renderJobAction",value:function(e){var t=this;switch(e.status){case y.QUEUED:case y.RUNNING:return i.a.createElement(F.a,{title:"Cancel this job?",onConfirm:function(){t.props.cancelJob(e.id)},okText:"Yes",cancelText:"No"},i.a.createElement(M.a,{icon:"close",type:"danger",size:"small"}));default:return}}},{key:"renderTimeRangeSelectionControl",value:function(){return i.a.createElement(P.a,{defaultValue:t.defaultTimeRange,onChange:this.onChangeTimeRange.bind(this),dropdownMatchSelectWidth:!0,style:{width:"11em"}},i.a.createElement(P.a.Option,{value:"lastHour"},"Previous Hour"),i.a.createElement(P.a.Option,{value:"last48Hours"},"Previous 48 Hours"),i.a.createElement(P.a.Option,{value:"lastWeek"},"Previous Week"),i.a.createElement(P.a.Option,{value:"lastMonth"},"Previous Month"),i.a.createElement(P.a.Option,{value:"customRange"},"Custom Range"))}},{key:"renderTimeRangeControl",value:function(e){return i.a.createElement(i.a.Fragment,null,i.a.createElement(L.a.Item,{label:"From"},i.a.createElement(J.a,{showTime:!0,allowClear:!1,value:G()(e.start),onChange:this.onRangeFromChange.bind(this)})),i.a.createElement(L.a.Item,{label:"To"},i.a.createElement(J.a,{showTime:!0,allowClear:!1,value:G()(e.end),onChange:this.onRangeToChange.bind(this)})))}},{key:"renderSearchInput",value:function(){var e,t=this;if(this.state.showDates){var n=this.state.timeRange;"literal"===n.kind&&(e=this.renderTimeRangeControl(n))}return i.a.createElement(L.a,{layout:"inline",onSubmit:this.onSubmit.bind(this)},i.a.createElement(L.a.Item,null,i.a.createElement(x.a,{defaultValue:this.currentQuery,placeholder:"Search jobs",style:{width:"15em"},onChange:this.onChangeQuery.bind(this)})),i.a.createElement(L.a.Item,{label:"TimeRange"}),i.a.createElement(L.a.Item,null,this.renderTimeRangeSelectionControl()),e,i.a.createElement(L.a.Item,null,i.a.createElement(M.a,{icon:"search",type:"primary",htmlType:"submit"})),i.a.createElement(L.a.Item,null,i.a.createElement(U.a,{checkedChildren:"hide filters",unCheckedChildren:"show filters",onChange:this.onToggleFilterArea.bind(this)})),i.a.createElement(L.a.Item,null,i.a.createElement(qe,{onPoll:function(){t.doSearch(!0)},pubsub:this.pubsub,startPolling:!0,isPollerRunning:this.props.searchState===S.SEARCHING,showControls:this.props.showMonitoringControls,startOpen:!0})))}},{key:"onToggleFilterArea",value:function(e){this.setState({isFilterOpen:e})}},{key:"onFilterChange",value:function(e){var t=this,n=e;this.setState({currentJobStatusFilter:n},(function(){t.doSearch(!1)}))}},{key:"onChangeJobStatusAny",value:function(e){var t=this;e.target.checked&&this.setState({currentJobStatusFilter:["queued","running","canceled","success","error"]},(function(){t.doSearch(!1)}))}},{key:"onClickAny",value:function(){var e=this;this.setState({currentJobStatusFilter:["queued","running","canceled","success","error"]},(function(){e.doSearch(!1)}))}},{key:"onClickFinished",value:function(){var e=this;this.setState({currentJobStatusFilter:["canceled","success","error"]},(function(){e.doSearch(!1)}))}},{key:"onClickActive",value:function(){var e=this;this.setState({currentJobStatusFilter:["queued","running"]},(function(){e.doSearch(!1)}))}},{key:"renderFilterInput",value:function(){var e=ze;return i.a.createElement("div",{className:"UserJobs-filterArea"},i.a.createElement("span",{style:{color:"gray",fontWeight:"bold",marginRight:"10px"}},"Filter by Job Status"),i.a.createElement(M.a,{size:"small",onClick:this.onClickAny.bind(this)},i.a.createElement("i",null,"Any"))," ",i.a.createElement(M.a,{size:"small",onClick:this.onClickActive.bind(this)},i.a.createElement("i",null,"Active"))," ",i.a.createElement(M.a,{size:"small",onClick:this.onClickFinished.bind(this),style:{marginRight:"10px"}},i.a.createElement("i",null,"Finished")),i.a.createElement(D.a.Group,{options:e,onChange:this.onFilterChange.bind(this),value:this.state.currentJobStatusFilter}))}},{key:"renderControlBar",value:function(){var e,t={margin:"10px 10px 10px 0"};return this.state.isFilterOpen||(t.display="none"),this.state.isFilterOpen&&(e=i.a.createElement("div",{className:"Row",style:t},this.renderFilterInput())),i.a.createElement("div",{className:"Col"},i.a.createElement("div",{className:"Row"},this.renderSearchInput()),e)}},{key:"onClickDetail",value:function(e){this.setState({selectedJob:e})}},{key:"onCloseModal",value:function(){this.setState({selectedJob:null})}},{key:"renderJobDetail",value:function(){if(this.state.selectedJob){var e=i.a.createElement(M.a,{key:"cancel",onClick:this.onCloseModal.bind(this)},"Close"),t=i.a.createElement("span",null,"Detail for Job ",i.a.createElement("span",{style:{fontFamily:"monospace",fontWeight:"bold"}},this.state.selectedJob.id));return i.a.createElement(j.a,{className:"FullScreenModal",title:t,onCancel:this.onCloseModal.bind(this),visible:!0,footer:e},i.a.createElement(Le,{jobID:this.state.selectedJob.id}))}}},{key:"renderJobsTable",value:function(){var e=this,t=this.props.searchState===S.SEARCHING;return i.a.createElement(T.a,{size:"small",className:"UserJobs-table xScrollingFlexTable",dataSource:this.props.jobs,loading:t,rowKey:function(e){return e.id},pagination:{position:"bottom",showSizeChanger:!0}},i.a.createElement(T.a.Column,{title:"ID",dataIndex:"id",key:"id",width:"8%",render:function(t,n){var r=t;return i.a.createElement(I.a,{title:r},i.a.createElement("a",{href:"https://example.com",onClick:function(t){t.preventDefault(),e.onClickDetail(n)}},t))}}),i.a.createElement(T.a.Column,{title:"User",dataIndex:"username",key:"username",width:"10%",render:function(e){return i.a.createElement(ie,{path:"people/".concat(e),openIn:"new-tab"},e)}}),i.a.createElement(T.a.Column,{title:"Narrative",dataIndex:"narrativeTitle",key:"narrativeTitle",width:"17%",render:function(e,t){return e&&t.narrativeID?i.a.createElement(I.a,{title:e},i.a.createElement(se,{narrativeID:t.narrativeID},e)):"n/a"}}),i.a.createElement(T.a.Column,{title:"App",dataIndex:"appTitle",key:"appTitle",width:"18%",render:function(e,t){return e?i.a.createElement(I.a,{title:e},i.a.createElement(ie,{path:"catalog/apps/".concat(t.appID),openIn:"same-window"},e)):"n/a"}}),i.a.createElement(T.a.Column,{title:"Submitted",dataIndex:"queuedAt",key:"queuedAt",width:"8%",render:function(e,t){return e?i.a.createElement(p.NiceRelativeTime,{time:new Date(e)}):i.a.createElement("span",null,"** empty **")},defaultSortOrder:"descend",sorter:function(e,t){return null===e.queuedAt?null===t.queuedAt?0:-1:null===t.queuedAt?1:e.queuedAt-t.queuedAt}}),i.a.createElement(T.a.Column,{title:"Queued",dataIndex:"queuedElapsed",key:"queuedElapsed",width:"10%",render:function(e,t){switch(t.status){case y.QUEUED:return i.a.createElement(p.NiceElapsedTime,{from:t.queuedAt,precision:2,useClock:!0});case y.ERRORED_QUEUED:case y.CANCELED_QUEUED:return i.a.createElement(p.NiceElapsedTime,{from:t.queuedAt,to:t.finishAt,precision:2});default:return i.a.createElement(p.NiceElapsedTime,{from:t.queuedAt,to:t.runAt,precision:2})}}}),i.a.createElement(T.a.Column,{title:"Run",key:"runElapsed",width:"10%",render:function(e,t){switch(t.status){case y.QUEUED:case y.ERRORED_QUEUED:case y.CANCELED_QUEUED:return"-";case y.RUNNING:return i.a.createElement(p.NiceElapsedTime,{from:t.runAt,precision:2,useClock:!0});case y.FINISHED:case y.CANCELED_RUNNING:case y.ERRORED_RUNNING:return i.a.createElement(p.NiceElapsedTime,{from:t.runAt,to:t.finishAt,precision:2})}}}),i.a.createElement(T.a.Column,{title:"Status",dataIndex:"status",key:"status",width:"8%",render:function(e,t){return i.a.createElement(B,{job:t})}}),i.a.createElement(T.a.Column,{title:"Server",dataIndex:"clientGroups",key:"clientGroups",width:"8%",render:function(e){return e.join(",")}}),i.a.createElement(T.a.Column,{title:"Cancel",dataIndex:"action",key:"action",width:"5%",render:function(t,n){return e.renderJobAction(n)}}))}},{key:"render",value:function(){return i.a.createElement("div",{"data-k-b-testhook-component":"UserJobs",className:"UserJobs"},i.a.createElement("div",null,this.renderControlBar()),this.renderJobsTable(),this.renderJobDetail())}}]),t}(i.a.Component);Be.defaultTimeRange="last48Hours";var Ve=function(){function e(){Object(u.a)(this,e),this.pendingTasks=void 0,this.isCanceled=void 0,this.pendingTasks=new Map,this.isCanceled=!1}return Object(c.a)(e,[{key:"newID",value:function(){return Se.a.v4()}},{key:"cancel",value:function(e){e.isCanceled=!0,this.pendingTasks.delete(e.id)}},{key:"cancelPending",value:function(){var e=this;this.pendingTasks.forEach((function(t,n){e.cancel(t)}))}},{key:"done",value:function(e){this.pendingTasks.delete(e.id)}},{key:"spawn",value:function(e){return this.cancelPending(),this.request(e)}}]),e}();function We(){return{type:r.USER_JOBS_SEARCH_START}}function Ye(e,t,n,a){return{type:r.USER_JOBS_SEARCH_SUCCESS,searchExpression:a,rawJobs:e,jobs:t,jobsFetchedAt:n}}function Ke(e){return{type:r.USER_JOBS_SEARCH_ERROR,error:e}}var Xe=new(function(e){function t(){return Object(u.a)(this,t),Object(l.a)(this,Object(h.a)(t).apply(this,arguments))}return Object(d.a)(t,e),Object(c.a)(t,[{key:"request",value:function(e){var t=e.token,n=e.serviceWizardURL,r=e.from,a=e.to,i=new Ae({url:n,authorization:t,timeout:1e4}).getJobs({epoch_range:[r,a],user_ids:[]}).then((function(e){return e.job_states.map((function(e){return Te(e,"UNKNOWN")}))})),s={id:this.newID(),promise:i,isCanceled:!1};return this.pendingTasks.set(s.id,s),s}}]),t}(Ve));function $e(e){return{type:r.USER_JOBS_CANCEL_ERROR,error:e}}var Ze=Object(k.connect)((function(e,t){var n=e.auth.userAuthorization,r=e.views.userJobsView,a=r.searchState,i=r.jobs;if(!n)throw new Error("Not authorized!");return{jobs:i,searchState:a,showMonitoringControls:!0}}),(function(e,t){return{search:function(t){e(function(e){return function(t,n){var r,a,i,s,o,u,c,l,h,d,m,p,E,b;return Y.a.async((function(f){for(;;)switch(f.prev=f.next){case 0:if(t(We()),r=n(),a=r.auth.userAuthorization,i=r.app.config.services.ServiceWizard.url,a){f.next=5;break}return t(Ke({message:"Not authorized",code:"unauthorized"})),f.abrupt("return");case 5:if(s=n(),o=s.views.userJobsView,u=o.jobsFetchedAt,c=o.rawJobs,l=e.query.split(/\s+/).map((function(e){return new RegExp(e,"i")})),h=je(e.timeRange),d=Object(V.a)(h,2),m=d[0],p=d[1],u&&!e.forceSearch){f.next=18;break}return E=Xe.spawn({token:a.token,serviceWizardURL:i,from:m,to:p}),f.next=12,Y.a.awrap(E.promise);case 12:if(c=f.sent,!E.isCanceled){f.next=15;break}return f.abrupt("return");case 15:u=(new Date).getTime(),Xe.done(E),u=(new Date).getTime();case 18:b=c.filter((function(t){return l.every((function(e){return e.test(t.appTitle)||e.test(t.narrativeTitle)||e.test(t.id)||e.test(t.username)}))&&Ie(t,e.jobStatus)})),t(Ye(c,b,u,e));case 20:case"end":return f.stop()}}))}}(t))},cancelJob:function(t){e(function(e){return function(t,n){var a,i,s;return Y.a.async((function(o){for(;;)switch(o.prev=o.next){case 0:if(t({type:r.USER_JOBS_CANCEL_START}),a=n(),i=a.auth.userAuthorization,s=a.app.config.services.NarrativeJobService.url,i){o.next=5;break}return t($e({message:"no authorization",code:"no-authorization"})),o.abrupt("return");case 5:new ce.NarrativeJobServiceClient({url:s,token:i.token,module:"NarrativeJobService"}).cancelJob({job_id:e}).then((function(){t({type:r.USER_JOBS_CANCEL_SUCCESS}),t((function(e,t){var n,r,a,i,s,o,u,c,l,h,d,m,p;return Y.a.async((function(E){for(;;)switch(E.prev=E.next){case 0:if(e(We()),n=t(),r=n.auth.userAuthorization){E.next=5;break}return e(Ke({message:"Not authorized",code:"unauthorized"})),E.abrupt("return");case 5:if(a=t(),i=a.app.config.services.ServiceWizard.url,s=a.views.userJobsView.searchExpression){E.next=9;break}return Ke({message:"No search expression",code:"nosearchexpression"}),E.abrupt("return");case 9:return o=s.query.split(/\s+/).map((function(e){return new RegExp(e,"i")})),u=je(s.timeRange),c=Object(V.a)(u,2),l=c[0],h=c[1],d=Xe.spawn({token:r.token,serviceWizardURL:i,from:l,to:h}),E.next=14,Y.a.awrap(d.promise);case 14:if(m=E.sent,!d.isCanceled){E.next=17;break}return E.abrupt("return");case 17:Xe.done(d),p=m.filter((function(e){return o.every((function(t){return t.test(e.appTitle)||t.test(e.narrativeTitle)}))&&Ie(e,s.jobStatus)})),e(Ye(m,p,Date.now(),s));case 20:case"end":return E.stop()}}))}))})).catch((function(e){console.error("error canceling job",e),t($e({message:"error canceling job: "+e.message,code:"error-canceling"}))}));case 7:case"end":return o.stop()}}))}}(t))}}}))(Be),et=(n(843),[{label:"Queued",value:"queued"},{label:"Running",value:"running"},{label:"Canceled",value:"canceled"},{label:"Success",value:"success"},{label:"Error",value:"error"}]);var tt=function(e){function t(e){var n;return Object(u.a)(this,t),(n=Object(l.a)(this,Object(h.a)(t).call(this,e))).currentQuery=void 0,n.pubsub=void 0,n.currentQuery="",n.pubsub=new Fe,n.state={showDates:!1,currentJobStatusFilter:["queued","running","canceled","success","error"],timeRange:{kind:"preset",preset:t.defaultTimeRangePreset},isFilterOpen:!1,selectedJob:null,currentSort:null},n}return Object(d.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.doSearch(!0)}},{key:"componentDidUpdate",value:function(){this.props.searchState===S.SEARCHING?this.pubsub.send("searching",{is:!0}):this.pubsub.send("searching",{is:!1})}},{key:"onChangeTimeRange",value:function(e){var t=this;"customRange"!==e?this.setState({showDates:!1,timeRange:{kind:"preset",preset:e}},(function(){t.doSearch(!0)})):this.setState({showDates:!0,timeRange:{kind:"literal",start:Date.now(),end:Date.now()}})}},{key:"onChangeQuery",value:function(e){this.currentQuery=e.target.value}},{key:"onSubmit",value:function(e){e.preventDefault(),this.doSearch(!0)}},{key:"doSearch",value:function(e){if("undefined"!==typeof this.currentQuery){var t=function(e){var t=[];return e.forEach((function(e){switch(e){case"queued":t.push(y.QUEUED);break;case"running":t.push(y.RUNNING);break;case"canceled":t.push(y.CANCELED_QUEUED),t.push(y.CANCELED_RUNNING);break;case"success":t.push(y.FINISHED);break;case"error":t.push(y.ERRORED_QUEUED),t.push(y.ERRORED_RUNNING)}})),t}(this.state.currentJobStatusFilter),n={query:this.currentQuery,timeRange:this.state.timeRange,jobStatus:t,forceSearch:e,sort:null};return this.pubsub.send("search",{}),this.props.search(n),!1}}},{key:"onRangeFromChange",value:function(e,t){if(null!==e){var n,r=this.state.timeRange;switch(r.kind){case"preset":n={kind:"literal",start:e.valueOf(),end:1/0};break;case"literal":n={kind:"literal",start:e.valueOf(),end:r.end};break;default:return}this.setState({timeRange:n})}else this.setState({timeRange:{kind:"preset",preset:"lastHour"}})}},{key:"onRangeToChange",value:function(e,t){if(null!==e){var n,r=this.state.timeRange;switch(r.kind){case"preset":n={kind:"literal",start:1/0,end:e.valueOf()};break;case"literal":n={kind:"literal",start:r.start,end:e.valueOf()};break;default:return}this.setState({timeRange:n})}else this.setState({timeRange:{kind:"preset",preset:"lastHour"}})}},{key:"renderSearchInput",value:function(){var e,n=this;if(this.state.showDates){var r=this.state.timeRange;"literal"===r.kind&&(e=i.a.createElement(i.a.Fragment,null,i.a.createElement(L.a.Item,{label:"From"},i.a.createElement(J.a,{showTime:!0,allowClear:!1,value:G()(r.start),onChange:this.onRangeFromChange.bind(this)})),i.a.createElement(L.a.Item,{label:"To"},i.a.createElement(J.a,{showTime:!0,allowClear:!1,value:G()(r.end),onChange:this.onRangeToChange.bind(this)}))))}return i.a.createElement(L.a,{layout:"inline",onSubmit:this.onSubmit.bind(this)},i.a.createElement(L.a.Item,null,i.a.createElement(x.a,{defaultValue:this.currentQuery,placeholder:"Search jobs",style:{width:"15em"},onChange:this.onChangeQuery.bind(this)})),i.a.createElement(L.a.Item,{label:"TimeRange"}),i.a.createElement(L.a.Item,null,i.a.createElement(P.a,{defaultValue:t.defaultTimeRangePreset,onChange:this.onChangeTimeRange.bind(this),dropdownMatchSelectWidth:!0,style:{width:"11em"}},i.a.createElement(P.a.Option,{value:"lastHour"},"Previous Hour"),i.a.createElement(P.a.Option,{value:"last48Hours"},"Previous 48 Hours"),i.a.createElement(P.a.Option,{value:"lastWeek"},"Previous Week"),i.a.createElement(P.a.Option,{value:"lastMonth"},"Previous Month"),i.a.createElement(P.a.Option,{value:"customRange"},"Custom Range"))),e,i.a.createElement(L.a.Item,null,i.a.createElement(M.a,{icon:"search",type:"primary",htmlType:"submit"})),i.a.createElement(L.a.Item,null,i.a.createElement(U.a,{checkedChildren:"hide filters",unCheckedChildren:"show filters",onChange:this.onToggleFilterArea.bind(this)})),i.a.createElement(L.a.Item,null,i.a.createElement(qe,{onPoll:function(){n.doSearch(!0)},pubsub:this.pubsub,isPollerRunning:this.props.searchState===S.SEARCHING,startPolling:!1,showControls:this.props.showMonitoringControls,startOpen:!1})))}},{key:"onToggleFilterArea",value:function(e){this.setState({isFilterOpen:e})}},{key:"onFilterChange",value:function(e){var t=this,n=e;this.setState({currentJobStatusFilter:n},(function(){t.doSearch(!1)}))}},{key:"onChangeJobStatusAny",value:function(e){var t=this;e.target.checked&&this.setState({currentJobStatusFilter:["queued","running","canceled","success","error"]},(function(){t.doSearch(!1)}))}},{key:"onClickAny",value:function(){var e=this;this.setState({currentJobStatusFilter:["queued","running","canceled","success","error"]},(function(){e.doSearch(!1)}))}},{key:"onClickFinished",value:function(){var e=this;this.setState({currentJobStatusFilter:["canceled","success","error"]},(function(){e.doSearch(!1)}))}},{key:"onClickActive",value:function(){var e=this;this.setState({currentJobStatusFilter:["queued","running"]},(function(){e.doSearch(!1)}))}},{key:"renderFilterInput",value:function(){var e=et;return i.a.createElement("div",{className:"MyJobs-filterArea"},i.a.createElement("span",{style:{color:"gray",fontWeight:"bold",marginRight:"10px"}},"Filter by Job Status"),i.a.createElement(M.a,{size:"small",type:"link",onClick:this.onClickAny.bind(this),"data-k-b-testhook-button":"any"},i.a.createElement("i",null,"Any"))," ",i.a.createElement(M.a,{size:"small",type:"link",onClick:this.onClickActive.bind(this),"data-k-b-testhook-button":"active"},i.a.createElement("i",null,"Active"))," ",i.a.createElement(M.a,{size:"small",type:"link",onClick:this.onClickFinished.bind(this),style:{marginRight:"10px"},"data-k-b-testhook-button":"finished"},i.a.createElement("i",null,"Finished")),i.a.createElement(D.a.Group,{options:e,onChange:this.onFilterChange.bind(this),value:this.state.currentJobStatusFilter}))}},{key:"renderControlBar",value:function(){var e,t={margin:"10px 10px 10px 0"};return this.state.isFilterOpen||(t.display="none"),this.state.isFilterOpen&&(e=i.a.createElement("div",{className:"Row",style:t},this.renderFilterInput())),i.a.createElement("div",{className:"Col"},i.a.createElement("div",{className:"Row"},this.renderSearchInput()),e)}},{key:"onJobCancel",value:function(e){this.props.cancelJob(e.id)}},{key:"renderJobAction",value:function(e){var t=this;switch(e.status){case y.QUEUED:case y.RUNNING:return i.a.createElement(F.a,{title:"Cancel this job?",onConfirm:function(){t.onJobCancel(e)},okText:"Yes",cancelText:"No"},i.a.createElement(M.a,{icon:"close",type:"danger",size:"small","data-k-b-testhook-button":"cancel"}));default:return}}},{key:"onClickDetail",value:function(e){this.setState({selectedJob:e})}},{key:"onCloseModal",value:function(){this.setState({selectedJob:null})}},{key:"renderNarrativeLink",value:function(e){var t=e.narrativeID;if(null!==t)return i.a.createElement(se,{narrativeID:t},e.narrativeTitle)}},{key:"renderError",value:function(e){return i.a.createElement(O.a,{type:"error",message:e.message})}},{key:"renderJobsTable",value:function(){var e=this;if(console.log("render jobs table...",this.props,this.props.searchState===S.ERROR),this.props.searchState===S.ERROR)return this.props.error?this.renderError(this.props.error):this.renderError({code:"Unknown",message:"Unknown error"});var t=this.props.searchState===S.SEARCHING;return i.a.createElement(T.a,{size:"small",className:"MyJobs-table xScrollingFlexTable",dataSource:this.props.jobs,loading:t,rowKey:function(e){return e.id},pagination:{position:"bottom",showSizeChanger:!0}},i.a.createElement(T.a.Column,{title:"ID",dataIndex:"id",key:"id",width:"10%",render:function(t,n){var r=t;return i.a.createElement(I.a,{title:r},i.a.createElement("a",{href:"https://example.com",onClick:function(t){t.preventDefault(),e.onClickDetail(n)}},t))}}),i.a.createElement(T.a.Column,{title:"Narrative",dataIndex:"narrativeTitle",key:"narrativeTitle",width:"17%",render:function(t,n){return t&&n.narrativeID?i.a.createElement(I.a,{title:t},e.renderNarrativeLink(n)):"n/a"}}),i.a.createElement(T.a.Column,{title:"App",dataIndex:"appTitle",key:"appTitle",width:"20%",render:function(e,t){return e?i.a.createElement(I.a,{title:e},i.a.createElement(ie,{path:"catalog/apps/".concat(t.appID),openIn:"new-tab"},e)):"n/a"}}),i.a.createElement(T.a.Column,{title:"Submitted",dataIndex:"queuedAt",key:"queuedAt",width:"10%",render:function(e,t){return e?i.a.createElement(p.NiceRelativeTime,{time:new Date(e)}):i.a.createElement("span",null,"** empty **")},defaultSortOrder:"descend",sorter:function(e,t,n){var r;return r="ascend"===n?-1:1,null===e.queuedAt?null===t.queuedAt?0:-1*r:null===t.queuedAt?1*r:(e.queuedAt-t.queuedAt)*r}}),i.a.createElement(T.a.Column,{title:"Queued",dataIndex:"queuedElapsed",key:"queuedElapsed",width:"10%",render:function(e,t){switch(t.status){case y.QUEUED:return i.a.createElement(p.NiceElapsedTime,{from:t.queuedAt,precision:2,useClock:!0});case y.ERRORED_QUEUED:case y.CANCELED_QUEUED:return i.a.createElement(p.NiceElapsedTime,{from:t.queuedAt,to:t.finishAt,precision:2});default:return i.a.createElement(p.NiceElapsedTime,{from:t.queuedAt,to:t.runAt,precision:2})}}}),i.a.createElement(T.a.Column,{title:"Run",key:"runElapsed",width:"10%",render:function(e,t){switch(t.status){case y.QUEUED:case y.ERRORED_QUEUED:case y.CANCELED_QUEUED:return"-";case y.RUNNING:return i.a.createElement(p.NiceElapsedTime,{from:t.runAt,precision:2,useClock:!0});case y.FINISHED:case y.CANCELED_RUNNING:case y.ERRORED_RUNNING:return i.a.createElement(p.NiceElapsedTime,{from:t.runAt,to:t.finishAt,precision:2})}}}),i.a.createElement(T.a.Column,{title:"Status",dataIndex:"status",key:"status",width:"10%",render:function(e,t){return i.a.createElement(B,{job:t})}}),i.a.createElement(T.a.Column,{title:"Server",dataIndex:"clientGroups",key:"clientGroups",width:"8%",render:function(e){return e.join(",")}}),i.a.createElement(T.a.Column,{title:"Cancel",dataIndex:"action",key:"action",width:"5%",render:function(t,n){return e.renderJobAction(n)}}))}},{key:"renderJobDetail",value:function(){if(this.state.selectedJob){var e=i.a.createElement(M.a,{key:"cancel",onClick:this.onCloseModal.bind(this)},"Close"),t=i.a.createElement("span",null,"Detail for Job ",i.a.createElement("span",{style:{fontFamily:"monospace",fontWeight:"bold"}},this.state.selectedJob.id));return i.a.createElement(j.a,{className:"FullScreenModal",title:t,onCancel:this.onCloseModal.bind(this),visible:!0,footer:e},i.a.createElement(Le,{jobID:this.state.selectedJob.id}))}}},{key:"render",value:function(){return i.a.createElement("div",{"data-k-b-testhook-component":"MyJobs",className:"MyJobs"},i.a.createElement("div",null,this.renderControlBar()),this.renderJobsTable(),this.renderJobDetail())}}]),t}(i.a.Component);function nt(){return{type:r.MY_JOBS_SEARCH_START}}function rt(e,t,n,a){return{type:r.MY_JOBS_SEARCH_SUCCESS,searchExpression:a,rawJobs:e,jobs:t,jobsFetchedAt:n}}function at(e){return{type:r.MY_JOBS_SEARCH_ERROR,error:e}}tt.defaultTimeRangePreset="lastWeek";var it=new(function(e){function t(){return Object(u.a)(this,t),Object(l.a)(this,Object(h.a)(t).apply(this,arguments))}return Object(d.a)(t,e),Object(c.a)(t,[{key:"request",value:function(e){var t=e.token,n=e.username,r=e.serviceWizardURL,a=e.from,i=e.to,s=new Ae({url:r,authorization:t,timeout:6e4}).getJobs({epoch_range:[a,i],user_ids:[n]}).then((function(e){return e.job_states.map((function(e){return Te(e,n)}))})).catch((function(e){throw console.error("Error fetching job",e),e})),o={id:this.newID(),promise:s,isCanceled:!1};return this.pendingTasks.set(o.id,o),o}}]),t}(Ve));function st(){return function(e,t){var n,r,a,i,s,o,u,c,l,h,d,m,p;return Y.a.async((function(E){for(;;)switch(E.prev=E.next){case 0:if(e(nt()),n=t(),r=n.auth.userAuthorization){E.next=5;break}return e(at({message:"Not authorized",code:"unauthorized"})),E.abrupt("return");case 5:if(a=t(),i=a.app.config.services.ServiceWizard.url,s=a.views.myJobsView.searchExpression){E.next=9;break}return at({message:"No search expression",code:"nosearchexpression"}),E.abrupt("return");case 9:return o=je(s.timeRange),u=Object(V.a)(o,2),c=u[0],l=u[1],h=s.query.split(/\s+/).map((function(e){return new RegExp(e,"i")})),d=it.spawn({token:r.token,username:r.username,serviceWizardURL:i,from:c,to:l}),E.next=14,Y.a.awrap(d.promise);case 14:if(m=E.sent,!d.isCanceled){E.next=17;break}return E.abrupt("return");case 17:it.done(d),p=m.filter((function(e){return h.every((function(t){return t.test(e.appTitle)||t.test(e.narrativeTitle)}))&&Ie(e,s.jobStatus)})),e(rt(m,p,Date.now(),s));case 20:case"end":return E.stop()}}))}}function ot(e){return{type:r.MY_JOBS_CANCEL_ERROR,error:e}}var ut=Object(k.connect)((function(e,t){var n=e.auth.userAuthorization,r=e.views.myJobsView,a=r.searchState,i=r.jobs,s=r.error;if(!n)throw new Error("Not authorized!");return{jobs:i,error:s,searchState:a,showMonitoringControls:!0}}),(function(e,t){return{search:function(t){e(function(e){return function(t,n){var r,a,i,s,o,u,c,l,h,d,m,p,E,b;return Y.a.async((function(f){for(;;)switch(f.prev=f.next){case 0:if(t(nt()),r=n(),a=r.auth.userAuthorization){f.next=5;break}return t(at({message:"Not authorized",code:"unauthorized"})),f.abrupt("return");case 5:if(i=n(),s=i.app.config.services.ServiceWizard.url,o=i.views.myJobsView,u=o.jobsFetchedAt,c=o.rawJobs,l=e.query.split(/\s+/).map((function(e){return new RegExp(e,"i")})),h=je(e.timeRange),d=Object(V.a)(h,2),m=d[0],p=d[1],u&&!e.forceSearch){f.next=25;break}return E=it.spawn({token:a.token,username:a.username,serviceWizardURL:s,from:m,to:p}),f.prev=10,f.next=13,Y.a.awrap(E.promise);case 13:c=f.sent,f.next=21;break;case 16:return f.prev=16,f.t0=f.catch(10),console.error("ERROR",f.t0),t(at({code:"my-jobs-fetch-error",message:"Error fetching jobs: "+f.t0.message})),f.abrupt("return");case 21:if(!E.isCanceled){f.next=23;break}return f.abrupt("return");case 23:u=(new Date).getTime(),it.done(E);case 25:b=c.filter((function(t){return l.every((function(e){return e.test(t.appTitle)||e.test(t.narrativeTitle)}))&&Ie(t,e.jobStatus)})),t(rt(c,b,u,e));case 27:case"end":return f.stop()}}),null,null,[[10,16]])}}(t))},cancelJob:function(t){e(function(e){return function(t,n){var a,i,s;return Y.a.async((function(o){for(;;)switch(o.prev=o.next){case 0:if(t({type:r.MY_JOBS_CANCEL_START}),a=n(),i=a.auth.userAuthorization,s=a.app.config.services.NarrativeJobService.url,i){o.next=5;break}return t(ot({message:"no authorization",code:"no-authorization"})),o.abrupt("return");case 5:new ce.NarrativeJobServiceClient({url:s,token:i.token,module:"NarrativeJobService"}).cancelJob({job_id:e}).then((function(){t({type:r.MY_JOBS_CANCEL_SUCCESS}),t(st())})).catch((function(e){console.error("error canceling job",e),t(ot({message:"error canceling job: "+e.message,code:"error-canceling"}))}));case 7:case"end":return o.stop()}}))}}(t))},refreshSearch:function(){e(st())}}}))(tt),ct=(n(844),function(e){function t(e){var n;return Object(u.a)(this,t),(n=Object(l.a)(this,Object(h.a)(t).call(this,e))).currentQuery=void 0,n.currentQuery="",n}return Object(d.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.props.onSearch({query:this.currentQuery})}},{key:"onSubmitSearch",value:function(e){e.preventDefault(),this.props.onSearch({query:this.currentQuery})}},{key:"onChangeQuery",value:function(e){this.currentQuery=e.target.value}},{key:"renderControlBar",value:function(){return i.a.createElement(L.a,{layout:"inline",onSubmit:this.onSubmitSearch.bind(this)},i.a.createElement(L.a.Item,null,i.a.createElement(x.a,{defaultValue:this.currentQuery,placeholder:"Search App Stats (leave empty for all)",style:{width:"20em"},onChange:this.onChangeQuery.bind(this)})),i.a.createElement(L.a.Item,null,i.a.createElement(M.a,{icon:"search",type:"primary",htmlType:"submit"})))}},{key:"onTableChange",value:function(e,t,n){}},{key:"renderAppStatsTable",value:function(){return i.a.createElement(T.a,{dataSource:this.props.appStats,loading:this.props.searchState===S.SEARCHING,rowKey:function(e){return e.appId},pagination:{position:"bottom",showSizeChanger:!0},size:"small",className:"PreciseTable ScrollingFlexTable",onChange:this.onTableChange},i.a.createElement(T.a.Column,{title:"Module",dataIndex:"moduleId",key:"moduleId",width:"25%",render:function(e,t){return i.a.createElement(I.a,{title:t.moduleTitle},i.a.createElement(ie,{path:"catalog/modules/".concat(e),openIn:"new-tab"},t.moduleTitle))},sorter:function(e,t){return e.moduleTitle.localeCompare(t.moduleTitle)},defaultSortOrder:"ascend"}),i.a.createElement(T.a.Column,{title:"Function",dataIndex:"functionId",key:"functionId",width:"25%",render:function(e,t){return i.a.createElement(I.a,{title:t.functionTitle},i.a.createElement(ie,{path:"catalog/apps/".concat(t.moduleId,"/").concat(t.functionId),openIn:"new-tab"},t.functionTitle))},sorter:function(e,t){return e.functionTitle.localeCompare(t.functionTitle)}}),i.a.createElement(T.a.Column,{title:"Runs",dataIndex:"runCount",key:"runCount",width:"5%",align:"right",render:function(e){return i.a.createElement("div",{className:"NumericColumn"},new Intl.NumberFormat("en-US",{useGrouping:!0}).format(e))},sorter:function(e,t){return e.runCount-t.runCount}}),i.a.createElement(T.a.Column,{title:"Errors",dataIndex:"errorCount",key:"errorCount",width:"5%",align:"right",render:function(e){return i.a.createElement("div",{className:"NumericColumn"},new Intl.NumberFormat("en-US",{useGrouping:!0}).format(e))},sorter:function(e,t){return e.errorCount-t.errorCount}}),i.a.createElement(T.a.Column,{title:"Success",dataIndex:"successRate",key:"successRate",width:"10%",render:function(e){return i.a.createElement(Je.a,{percent:100*e,format:function(t){return new Intl.NumberFormat("en-US",{style:"percent"}).format(e)}})},sorter:function(e,t){return e.successRate-t.successRate}}),i.a.createElement(T.a.Column,{title:"Avg Run",dataIndex:"averageRunTime",key:"averageRunTime",width:"10%",render:function(e){return i.a.createElement(p.NiceTimeDuration,{precision:2,duration:1e3*e})},sorter:function(e,t){return e.averageRunTime-t.averageRunTime}}),i.a.createElement(T.a.Column,{title:"Avg Queue",dataIndex:"averageQueueTime",key:"averageQueueTime",width:"10%",render:function(e){return i.a.createElement(p.NiceTimeDuration,{precision:2,duration:1e3*e})},sorter:function(e,t){return e.averageQueueTime-t.averageQueueTime}}),i.a.createElement(T.a.Column,{title:"Total Run",dataIndex:"totalRunTime",key:"totalRunTime",width:"10%",render:function(e){return i.a.createElement(p.NiceTimeDuration,{precision:2,duration:1e3*e})},sorter:function(e,t){return e.totalRunTime-t.totalRunTime}}))}},{key:"render",value:function(){return i.a.createElement("div",{className:"PublicAppStats"},this.renderControlBar(),this.renderAppStatsTable())}}]),t}(i.a.Component));function lt(e,t){return e?t?e/t:null:t?0:null}function ht(e){return{type:r.PUBLIC_APP_STATS_SEARCH_ERROR,error:e}}var dt=Object(k.connect)((function(e,t){var n=e.views.publicAppStatsView,r=n.appStats;return{searchState:n.searchState,appStats:r}}),(function(e,t){return{onSearch:function(t){e(function(e){return function(t,n){var a,i,s,o,u,c,l,h;return Y.a.async((function(d){for(;;)switch(d.prev=d.next){case 0:if(t({type:r.PUBLIC_APP_STATS_SEARCH_START}),a=n(),i=a.auth.userAuthorization,s=a.app.config.services.Catalog.url,i){d.next=5;break}return t(ht({message:"Not authorized",code:"unauthorized"})),d.abrupt("return");case 5:if(i){d.next=8;break}return t(ht({message:"Not authorized",code:"unauthorized"})),d.abrupt("return");case 8:return o=new ce.CatalogClient({module:"Catalog",token:i.token,url:s}),d.next=11,Y.a.awrap(o.getExecAggrStats({}));case 11:u=d.sent,c=u.map((function(e){var t=e.full_app_id.split("/"),n=Object(V.a)(t,2),r=n[0],a=n[1];r&&a||console.warn("bad app!",e);var i,s,o=(i=e.number_of_calls-e.number_of_errors,s=e.number_of_calls,i?s?i/s:null:s?0:null),u=lt(e.total_exec_time,e.number_of_calls),c=lt(e.total_queue_time,e.number_of_calls);return{appId:e.full_app_id,moduleId:r,functionId:a||"",moduleTitle:r,functionTitle:a||"",runCount:e.number_of_calls,errorCount:e.number_of_errors,successRate:o,averageRunTime:u,averageQueueTime:c,totalRunTime:e.total_queue_time}})),l=e.query.split(/\s+/).map((function(e){return new RegExp(e,"i")})),h=c.filter((function(e){return l.every((function(t){return t.test(e.moduleTitle)||t.test(e.moduleId)||t.test(e.functionTitle)||t.test(e.functionId)}))})),t((m=h,{type:r.PUBLIC_APP_STATS_SEARCH_SUCCESS,appStats:m}));case 16:case"end":return d.stop()}var m}))}}(t))}}}))(ct),mt=(n(845),function(e){function t(e){var n;return Object(u.a)(this,t),(n=Object(l.a)(this,Object(h.a)(t).call(this,e))).currentQuery=void 0,n.currentQuery={query:""},n}return Object(d.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.props.search(this.currentQuery)}},{key:"onSubmitSearch",value:function(e){e.preventDefault(),this.props.search(this.currentQuery)}},{key:"onChangeQuery",value:function(e){this.currentQuery.query=e.target.value}},{key:"renderControlBar",value:function(){return i.a.createElement(L.a,{layout:"inline",onSubmit:this.onSubmitSearch.bind(this)},i.a.createElement(L.a.Item,null,i.a.createElement(x.a,{defaultValue:this.currentQuery.query,placeholder:"Search (leave empty for all)",style:{width:"20em"},onChange:this.onChangeQuery.bind(this)})),i.a.createElement(L.a.Item,null,i.a.createElement(M.a,{icon:"search",type:"primary",htmlType:"submit"})))}},{key:"renderTable",value:function(){return i.a.createElement(T.a,{dataSource:this.props.userRunSummary,loading:this.props.searchState===S.SEARCHING,rowKey:function(e){return[e.username,e.appId,e.moduleName,e.functionName].join(":")},pagination:{position:"bottom",showSizeChanger:!0},size:"small",className:"PreciseTable ScrollingFlexTable"},i.a.createElement(T.a.Column,{title:"User",dataIndex:"username",width:"30%",render:function(e,t){return i.a.createElement(I.a,{title:e},i.a.createElement(ie,{path:"people/".concat(e),openIn:"same-window"},e))},sorter:function(e,t){return e.username.localeCompare(t.username)}}),i.a.createElement(T.a.Column,{title:"Module",dataIndex:"moduleName",width:"30%",render:function(e){return i.a.createElement(I.a,{title:e},i.a.createElement(ie,{path:"catalog/modules/".concat(e),openIn:"same-window"},e))},sorter:function(e,t){return e.moduleName.localeCompare(t.moduleName)}}),i.a.createElement(T.a.Column,{title:"Function",dataIndex:"functionName",width:"30%",render:function(e,t){return i.a.createElement(I.a,{title:e},i.a.createElement(ie,{path:"catalog/apps/".concat(t.appId),openIn:"same-window"},e))},sorter:function(e,t){return e.functionName.localeCompare(t.functionName)}}),i.a.createElement(T.a.Column,{title:"Runs",dataIndex:"runCount",width:"10%",align:"right",render:function(e,t){return i.a.createElement("div",{className:"NumericColumn"},Intl.NumberFormat("en-US",{useGrouping:!0}).format(e))},sorter:function(e,t){return e.runCount-t.runCount},defaultSortOrder:"descend"}))}},{key:"render",value:function(){return i.a.createElement("div",{className:"UserRunSummary"},this.renderControlBar(),this.renderTable())}}]),t}(i.a.Component));function pt(e){return{type:r.USER_RUN_SUMMARY_SEARCH_ERROR,error:e}}var Et=Object(k.connect)((function(e,t){var n=e.views.userRunSummaryView;return{searchState:n.searchState,userRunSummary:n.userRunSummary}}),(function(e,t){return{search:function(t){e(function(e){return function(t,n){var a,i,s,o,u,c,l,h,d;return Y.a.async((function(m){for(;;)switch(m.prev=m.next){case 0:if(t({type:r.USER_RUN_SUMMARY_SEARCH_START}),a=n(),i=a.auth.userAuthorization,s=a.app.config.services.Catalog.url,i){m.next=5;break}return t(pt({message:"Not authorized",code:"unauthorized"})),m.abrupt("return");case 5:if(i){m.next=8;break}return t(pt({message:"Not authorized",code:"unauthorized"})),m.abrupt("return");case 8:return o=new ce.CatalogClient({module:"Catalog",token:i.token,url:s}),u={begin:0,end:Date.now()},m.next=12,Y.a.awrap(o.getExecAggrTable(u));case 12:c=m.sent,l=c.map((function(e){var t=e.app;return t||(t=null),{username:e.user,isApp:!!e.app,appId:e.app||null,moduleName:e.func_mod,functionName:e.func,runCount:e.n}})),h=e.query.split(/\s+/).map((function(e){return new RegExp(e,"i")})),d=l.filter((function(e){return h.every((function(t){return e.appId&&t.test(e.appId)||t.test(e.moduleName)||t.test(e.functionName)||t.test(e.username)}))})),t((p=d,{type:r.USER_RUN_SUMMARY_SEARCH_SUCCESS,userRunSummary:p}));case 17:case"end":return m.stop()}var p}))}}(t))}}}))(mt),bt=function(e){function t(e){var n;return Object(u.a)(this,t),(n=Object(l.a)(this,Object(h.a)(t).call(this,e))).defaultTabKey=void 0,n.defaultTabKey="myJobs",n.state={activeTabKey:n.defaultTabKey,defaultActiveTabKey:n.defaultTabKey},n}return Object(d.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.props.setTitle("Job Browser")}},{key:"componentWillUnmount",value:function(){this.setState({activeTabKey:null})}},{key:"onTabsChange",value:function(e){this.setState({activeTabKey:e})}},{key:"renderJobsTab",value:function(){}},{key:"renderAdminJobsTab",value:function(){}},{key:"renderMyJobsTab",value:function(){return i.a.createElement(ut,null)}},{key:"renderUserJobsTab",value:function(){return i.a.createElement(Ze,null)}},{key:"renderPublicAppStatsTab",value:function(){return i.a.createElement(dt,null)}},{key:"renderUserRunSummaryTab",value:function(){return i.a.createElement(Et,null)}},{key:"renderTabs",value:function(){var e=[];if(e.push({tab:"myjobs",title:"My Jobs",component:this.renderMyJobsTab()}),this.props.isAdmin){var t=i.a.createElement("span",null,"User Jobs ",i.a.createElement(A.a,{type:"unlock"}));e.push({tab:"userjobs",title:t,component:i.a.createElement(Ze,null)})}if(e.push({tab:"appstats",title:"Public AppStats",component:this.renderPublicAppStatsTab()}),this.props.isAdmin){var n=i.a.createElement("span",null,"User Run Summary ",i.a.createElement(A.a,{type:"unlock"}));e.push({tab:"userrunsummary",title:n,component:i.a.createElement(Et,null)})}return i.a.createElement(K,{tabs:e})}},{key:"render",value:function(){return i.a.createElement("div",{className:"Col Col-scrollable","data-k-b-testhook-plugin":"job-browser2"},this.renderTabs())}}]),t}(i.a.Component);var ft=Object(k.connect)((function(e,t){var n=e.views.mainView.isAdmin,r=e.app.runtime.navigation;return{isAdmin:n,view:r.view,params:r.params}}),(function(e,t){return{setTitle:function(t){e(Object(p.sendTitle)(t))},setView:function(t){e(Object(p.setView)(t))},setParams:function(t){e(Object(p.setParams)(t))}}}))(bt);function vt(e){return{type:r.MAIN_LOAD_SUCCESS,isAdmin:e}}function yt(e){return{type:r.MAIN_LOAD_ERROR,error:e}}var St=function(e){function t(){return Object(u.a)(this,t),Object(l.a)(this,Object(h.a)(t).apply(this,arguments))}return Object(d.a)(t,e),Object(c.a)(t,[{key:"renderLoading",value:function(){var e=a.createElement("div",null,"Loading Main ... ",a.createElement(_.a,null));return a.createElement(O.a,{type:"info",message:e,style:{width:"20em",padding:"20px",margin:"20px auto"}})}},{key:"renderError",value:function(){if(this.props.view.error)return a.createElement(O.a,{type:"error",message:this.props.view.error.message})}},{key:"render",value:function(){switch(this.props.view.loadingState){case R.NONE:case R.LOADING:return this.renderLoading();case R.ERROR:return this.renderError();case R.SUCCESS:return a.createElement(ft,null)}}},{key:"componentDidMount",value:function(){switch(this.props.view.loadingState){case R.NONE:this.props.onLoad()}}},{key:"componentWillUnmount",value:function(){this.props.unload()}}]),t}(a.Component);var Rt=Object(k.connect)((function(e,t){var n=e.auth.userAuthorization;return{view:e.views.mainView,token:n.token}}),(function(e,t){return{onLoad:function(){e((function(e,t){var n,a,i,s,o;return Y.a.async((function(u){for(;;)switch(u.prev=u.next){case 0:if(e({type:r.MAIN_LOAD_START}),n=t(),a=n.auth.userAuthorization,i=n.app.config.services.Catalog.url,a){u.next=5;break}return e(yt({message:"Not authorized",code:"unauthorized"})),u.abrupt("return");case 5:return s=new ce.CatalogClient({token:a.token,url:i,module:"Catalog"}),u.prev=6,u.next=9,Y.a.awrap(s.isAdmin());case 9:o=u.sent,e(vt(!!o)),u.next=16;break;case 13:u.prev=13,u.t0=u.catch(6),e(yt({message:u.t0.message,code:"error-checking-admin-status"}));case 16:case"end":return u.stop()}}),null,null,[[6,13]])}))},unload:function(){e({type:r.MAIN_UNLOAD})}}}))(St),gt=function(e){function t(e){var n;return Object(u.a)(this,t),(n=Object(l.a)(this,Object(h.a)(t).call(this,e))).state={errorMessage:null},n}return Object(d.a)(t,e),Object(c.a)(t,[{key:"componentDidCatch",value:function(e,t){console.error("ERROR",e,t)}},{key:"render",value:function(){if(this.state.errorMessage){var e=this.state.errorMessage;return i.a.createElement(O.a,{type:"error",message:e})}return this.props.children}}],[{key:"getDerivedStateFromError",value:function(e){return{errorMessage:e.message}}}]),t}(i.a.Component),wt=(n(846),Object(N.d)(w,function(){var e=[],t=Object(p.makeBaseStoreState)();return Object(m.a)({},t,{views:{mainView:{loadingState:R.NONE,error:null,isAdmin:!1},myJobsView:{searchState:S.NONE,error:null,searchExpression:null,jobsFetchedAt:null,rawJobs:e,jobs:e},userJobsView:{searchState:S.NONE,searchExpression:null,jobsFetchedAt:null,rawJobs:e,jobs:e},publicAppStatsView:{searchState:S.NONE,rawAppStats:[],appStats:[],query:{query:""}},userRunSummaryView:{searchState:S.NONE,userRunSummary:[],query:{query:""}}}})}(),Object(N.c)(Object(N.a)(C.a)))),Nt=function(e){function t(e){var n;return Object(u.a)(this,t),(n=Object(l.a)(this,Object(h.a)(t).call(this,e))).state={},n}return Object(d.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){return i.a.createElement(gt,null,i.a.createElement(k.Provider,{store:wt},i.a.createElement(p.AppBase,null,i.a.createElement(p.AuthGate,{required:!0},i.a.createElement(Rt,null)))))}}]),t}(i.a.Component);Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));o.a.render(i.a.createElement(Nt,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()}))}},[[419,1,2]]]);
//# sourceMappingURL=main.998f521c.chunk.js.map